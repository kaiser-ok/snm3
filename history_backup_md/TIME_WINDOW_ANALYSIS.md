# 時間窗口與閾值分析

## ⚠️ 重要：時間單位差異

您的問題非常關鍵！**我們的系統與學術研究的時間單位不同**，這會顯著影響閾值的有效性。

---

## 🕐 我們的系統：5 分鐘窗口

### 數據聚合

```yaml
# nad/config.yaml
elasticsearch:
  indices:
    aggregated: netflow_stats_5m  # ← 5 分鐘聚合
```

### 聚合維度

```
時間窗口: 每 5 分鐘
聚合鍵: time_bucket (5分鐘) × src_ip
```

**實際意義**：

```
時間桶: 2025-11-13 10:00:00 ~ 10:05:00 (5分鐘)
    └─ 192.168.10.135
        ├─ flow_count: 3,497      # 5分鐘內的連線數
        ├─ unique_dst_ports: 2,125 # 5分鐘內掃描的端口數
        ├─ total_bytes: 4.9 MB     # 5分鐘內的總流量
        └─ ...
```

**關鍵點**：
- ✅ `flow_count = 3,497` → **5 分鐘內** 3,497 個連線
- ✅ `unique_dst_ports = 2,125` → **5 分鐘內** 掃描 2,125 個端口
- ✅ `total_bytes = 4.9 MB` → **5 分鐘內** 傳輸 4.9 MB

---

## 📚 學術研究：時間單位分析

### 1. 端口掃描研究

#### PLOS ONE (2018) - "Detection of slow port scans"

**研究中的時間定義**：

- **快速掃描 (Fast Scan)**：20 秒內完成
- **慢速掃描 (Slow Scan)**：1 小時到 1 天

**研究沒有明確指定**：
- "掃描 100 個端口" 是在**多長時間內**
- 但從上下文推斷：通常是**整個掃描活動的持續時間**

**Nmap 實際行為**：
```bash
# 快速掃描（默認）
nmap -T4 192.168.1.0/24
# 通常 1-5 分鐘內掃描 1000 個端口

# 慢速掃描（規避檢測）
nmap -T2 192.168.1.0/24
# 可能需要 10-30 分鐘
```

#### **關鍵差異**：

| 指標 | 學術研究（隱含） | 我們的系統 | 差異 |
|------|----------------|-----------|------|
| 時間窗口 | 整個掃描活動 (分鐘到小時) | **5 分鐘固定窗口** | ⚠️ 重大差異 |
| 端口數閾值 | > 100 | > 100 | ✅ 相同 |
| 實際意義 | 掃描活動總共掃描 > 100 端口 | **5 分鐘內**掃描 > 100 端口 | ⚠️ 更嚴格 |

---

### 2. DDoS 攻擊研究

#### MDPI Sensors (2023) - "SYN Flooding Attacks"

**研究中的速率**：
- 正常用戶：0.25 流/秒
- 攻擊者：5 流/秒

**換算到 5 分鐘窗口**：

```
正常用戶：
0.25 流/秒 × 300 秒 = 75 流/5分鐘

攻擊者：
5 流/秒 × 300 秒 = 1,500 流/5分鐘
```

**我們的閾值**：
```python
flow_count > 10,000  # DDoS 閾值
```

**換算成速率**：
```
10,000 流 / 300 秒 = 33.3 流/秒
```

#### **比較**：

| 指標 | 研究 (流/秒) | 我們 (流/5分鐘) | 我們 (換算流/秒) |
|------|------------|----------------|----------------|
| 正常用戶 | 0.25 | 75 | 0.25 |
| 攻擊者 | 5 | 1,500 | 5 |
| DDoS 閾值 | - | **10,000** | **33.3** |

**結論**：我們的 DDoS 閾值（33.3 流/秒）**遠高於**研究中的攻擊者速率（5 流/秒）

⚠️ **這意味著**：我們可能會**漏報**一些較慢的 DDoS 攻擊！

---

### 3. DNS 隧道研究

#### GIAC (2016) - "Detecting DNS Tunneling"

**研究中的速率**：
- 檢測閾值：0-400 bytes/秒

**我們的閾值**：
```python
flow_count > 1000       # 1000 個 DNS 查詢
avg_bytes < 1000        # 平均 < 1KB
```

**換算**：

```
1000 查詢 / 300 秒 = 3.33 查詢/秒

假設每個查詢 512 bytes（DNS 標準）：
3.33 × 512 = 1,705 bytes/秒
```

#### **比較**：

| 指標 | 研究 | 我們 (5分鐘窗口) | 我們 (換算) |
|------|------|----------------|------------|
| 速率閾值 | 400 bytes/秒 | 1000 查詢/5分鐘 | **1,705 bytes/秒** |

**結論**：我們的閾值**過於寬鬆**，可能會漏報 DNS 隧道！

---

### 4. 數據外洩研究

#### TU Delft (2019) - "Data exfiltration detection"

**研究特徵**：
- 流持續時間
- 字節數/秒
- 字節數/封包

**我們的閾值**：
```python
total_bytes > 1e9  # > 1GB
```

#### **問題**：

**5 分鐘傳輸 1GB 是什麼速度？**

```
1 GB = 1,073,741,824 bytes
1 GB / 300 秒 = 3,579,139 bytes/秒
              = 28.6 Mbps
```

**實際案例（您的數據）**：
```
144.195.35.179
- 總流量: 21 GB
- 時間窗口: 不明（可能是多個5分鐘窗口的總和）

假設是單一5分鐘窗口：
21 GB / 300 秒 = 597 Mbps（極高！）
```

#### **比較**：

| 場景 | 5分鐘流量 | 換算速率 | 評估 |
|------|---------|---------|------|
| 正常下載 | 100 MB | 2.7 Mbps | 正常 |
| 高清視頻 | 500 MB | 13.3 Mbps | 正常 |
| **我們的閾值** | **1 GB** | **28.6 Mbps** | 偏高但合理 |
| 實際外洩案例 | 21 GB | 597 Mbps | 異常！ |

---

## 📊 完整閾值時間單位對照表

| 威脅類型 | 參數 | 我們的閾值 | 時間窗口 | 換算速率 | 學術研究 | 評估 |
|---------|------|-----------|---------|---------|---------|------|
| **PORT_SCAN** | unique_dst_ports | > 100 | 5分鐘 | 20 端口/分鐘 | > 100 (總數) | ⚠️ 更嚴格 |
| | avg_bytes | < 5000 | 5分鐘 | - | < 5000 | ✅ 一致 |
| **NETWORK_SCAN** | unique_dsts | > 50 | 5分鐘 | 10 主機/分鐘 | 50-250 | ✅ 合理 |
| | flow_count | > 1000 | 5分鐘 | 3.33 流/秒 | - | ✅ 合理 |
| **DNS_TUNNELING** | flow_count | > 1000 | 5分鐘 | 3.33 查詢/秒 | - | ⚠️ 可能寬鬆 |
| | avg_bytes | < 1000 | 5分鐘 | - | < 512 | ⚠️ 寬鬆 |
| **DDOS** | flow_count | > 10000 | 5分鐘 | **33.3 流/秒** | 5 流/秒 (攻擊) | ⚠️ **過於寬鬆** |
| | avg_bytes | < 500 | 5分鐘 | - | 40-60 | ✅ 合理 |
| **DATA_EXFIL** | total_bytes | > 1GB | 5分鐘 | **28.6 Mbps** | - | ✅ 合理 |
| | unique_dsts | ≤ 5 | 5分鐘 | - | ≤ 5 | ✅ 一致 |
| **C2_COMM** | flow_count | 100-1000 | 5分鐘 | 0.33-3.33 流/秒 | 週期性 | ✅ 合理 |

---

## 🚨 關鍵問題與建議

### 問題 1: DDoS 閾值過高

**當前**：
```python
flow_count > 10000  # 33.3 流/秒
```

**問題**：
- 學術研究：攻擊者 5 流/秒
- 我們的閾值：33.3 流/秒（**高 6.6 倍**）

**建議調整**：
```python
# 保守建議（5分鐘窗口）
flow_count > 2000   # 6.67 流/秒（仍高於研究的5，但更安全）

# 激進建議
flow_count > 1500   # 5 流/秒（與研究一致）
```

### 問題 2: DNS 隧道閾值可能寬鬆

**當前**：
```python
flow_count > 1000   # 3.33 查詢/秒
avg_bytes < 1000    # 包括一些正常 DNS
```

**建議調整**：
```python
# 更嚴格的檢測
flow_count > 500    # 1.67 查詢/秒
avg_bytes < 600     # 更接近標準 DNS (512)
```

### 問題 3: 端口掃描閾值實際上更嚴格

**當前**：
```python
unique_dst_ports > 100  # 5分鐘內
```

**實際意義**：
- Nmap 快速掃描 1000 端口：可能需要 5-10 分鐘
- 在單一 5 分鐘窗口內掃描 > 100 端口 = **非常快速的掃描**

**評估**：
- ✅ 對快速掃描敏感（好）
- ⚠️ 可能漏報慢速掃描（如果掃描持續時間 > 5 分鐘）

**建議**：
```python
# 選項 1: 降低閾值（更敏感）
unique_dst_ports > 50   # 5分鐘內

# 選項 2: 保持現狀（平衡）
unique_dst_ports > 100  # 5分鐘內（當前）

# 選項 3: 提高閾值（更保守）
unique_dst_ports > 150  # 5分鐘內
```

---

## 🔄 跨窗口分析的問題

### 長時間攻擊的檢測

**場景**：慢速端口掃描

```
攻擊者策略: 掃描 1000 個端口，耗時 30 分鐘（規避檢測）
            = 每分鐘 33 個端口
            = 每 5 分鐘窗口 165 個端口
```

**我們的檢測**：
```
窗口 1 (00:00-00:05): 165 端口 → ✅ 檢測到 (> 100)
窗口 2 (00:05-00:10): 165 端口 → ✅ 檢測到
...
窗口 6 (00:25-00:30): 165 端口 → ✅ 檢測到
```

✅ **5 分鐘窗口實際上對慢速掃描也有效**！

---

### 極慢速攻擊（規避檢測）

**場景**：超慢速掃描

```
攻擊者策略: 掃描 1000 個端口，耗時 3 小時
            = 每分鐘 5.5 個端口
            = 每 5 分鐘窗口 27.5 個端口
```

**我們的檢測**：
```
每個窗口: 27.5 端口 → ❌ 未檢測到 (< 100)
```

⚠️ **這種超慢速攻擊會被漏報**

**解決方案**：
1. 降低閾值（可能增加誤報）
2. 實現跨窗口聚合（追蹤更長時間的行為）
3. 結合其他特徵（如端口分散度、目標多樣性）

---

## 🎯 建議的閾值調整

基於 5 分鐘時間窗口，以下是調整建議：

### 立即調整（高優先級）

#### 1. DDoS 檢測（過於寬鬆）

```python
# 當前
flow_count > 10000

# 建議
flow_count > 2000   # 6.67 流/秒（更接近研究）
```

#### 2. DNS 隧道（可能寬鬆）

```python
# 當前
flow_count > 1000
avg_bytes < 1000

# 建議
flow_count > 600    # 2 查詢/秒
avg_bytes < 600     # 更接近 DNS 標準
```

### 可選調整（根據環境）

#### 3. 端口掃描（當前較嚴格，可能調整）

```python
# 當前（適合快速掃描檢測）
unique_dst_ports > 100

# 如果想更敏感（可能增加誤報）
unique_dst_ports > 50

# 如果誤報太多（更保守）
unique_dst_ports > 150
```

---

## 📝 如何驗證閾值

### 方法 1: 實際測試

```bash
# 1. 執行已知攻擊（測試環境！）
# 例如：nmap 掃描
nmap -T4 -p 1-1000 192.168.1.100

# 2. 檢測是否被發現
python3 realtime_detection.py --minutes 10

# 3. 分析特徵
python3 verify_anomaly.py --ip <掃描來源IP> --minutes 10
```

### 方法 2: 分析歷史數據

```bash
# 使用優化工具分析
python3 optimize_classifier_thresholds.py --days 14

# 查看實際分佈
# 例如: DDoS 類型的 flow_count 實際分佈
# 如果 P10 = 15000，說明我們的 10000 閾值確實太低
```

### 方法 3: 逐步調整

```
1. 降低閾值（例如 DDoS: 10000 → 5000）
2. 運行檢測 1-2 天
3. 記錄誤報數量
4. 根據誤報率調整
5. 重複直到找到平衡點
```

---

## 🔍 結論

### 關鍵發現

1. ⚠️ **時間單位差異顯著**：
   - 學術研究：通常是整個攻擊活動（分鐘到小時）
   - 我們的系統：固定 5 分鐘窗口
   - 影響：閾值的實際意義完全不同

2. ⚠️ **部分閾值需要調整**：
   - DDoS：**過於寬鬆**（10000 → 建議 2000）
   - DNS 隧道：**可能寬鬆**（1000 → 建議 600）
   - 端口掃描：實際上**更嚴格**（適合快速掃描）

3. ✅ **部分閾值合理**：
   - 數據外洩：1GB/5分鐘 = 28.6 Mbps（合理）
   - 網路掃描：50 主機/5分鐘（合理）
   - C2 通訊：100-1000 流/5分鐘（合理）

### 下一步行動

1. **立即**：更新 `CLASSIFIER_THRESHOLDS_RESEARCH.md`，添加時間單位說明
2. **短期**：調整 DDoS 和 DNS 隧道閾值
3. **中期**：使用 `optimize_classifier_thresholds.py` 驗證調整
4. **長期**：考慮實現多時間窗口分析（5分鐘 + 1小時 + 24小時）

---

**版本**: 1.0
**創建日期**: 2025-11-13
**狀態**: Critical Analysis ⚠️
