# è®¾å¤‡ç±»å‹ç‰¹å¾ - å®æ–½å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆçš„æ”¹è¿›

### 1. è®¾å¤‡ç±»å‹é…ç½® (device_mapping.yaml)

**ä½ç½®**: `nad/device_mapping.yaml`

**åŠŸèƒ½**:
- å®šä¹‰ IP ç½‘æ®µä¸è®¾å¤‡ç±»å‹çš„æ˜ å°„å…³ç³»
- æ”¯æŒ 4 ç§è®¾å¤‡ç±»å‹ï¼šserver_farmï¼ˆæœåŠ¡å™¨ï¼‰ã€stationï¼ˆå·¥ä½œç«™ï¼‰ã€iotï¼ˆIoTè®¾å¤‡ï¼‰ã€externalï¼ˆå¤–éƒ¨/å…¶ä»–ï¼‰
- å¯çµæ´»é…ç½®ç‰¹æ®Šè®¾å¤‡

**ç¤ºä¾‹é…ç½®**:
```yaml
device_types:
  server_farm:
    ip_ranges:
      - 192.168.10.0/24
      - 10.10.10.0/24

  station:
    ip_ranges:
      - 192.168.20.0/24
      - 192.168.30.0/24
```

---

### 2. è®¾å¤‡åˆ†ç±»å™¨ (DeviceClassifier)

**ä½ç½®**: `nad/device_classifier.py`

**åŠŸèƒ½**:
- æ ¹æ® IP åœ°å€è‡ªåŠ¨åˆ¤æ–­è®¾å¤‡ç±»å‹
- æ”¯æŒ CIDR ç½‘æ®µåŒ¹é…
- æä¾›è®¾å¤‡ç±»å‹çš„ä¸­æ–‡åç§°å’Œ emoji å›¾æ ‡
- è¿”å›æ•°å€¼ç¼–ç ç”¨äºæœºå™¨å­¦ä¹ ç‰¹å¾

**API**:
```python
from nad.device_classifier import DeviceClassifier

classifier = DeviceClassifier()

# è·å–è®¾å¤‡ç±»å‹
device_type = classifier.classify('192.168.10.160')  # è¿”å›: 'server_farm'

# è·å–æ•°å€¼ç¼–ç ï¼ˆç”¨äº MLï¼‰
code = classifier.get_device_type_code('192.168.10.160')  # è¿”å›: 0

# è·å–æ˜¾ç¤ºåç§°
name = classifier.get_type_display_name('server_farm')  # è¿”å›: 'æœåŠ¡å™¨'

# è·å– emoji
emoji = classifier.get_type_emoji('server_farm')  # è¿”å›: 'ğŸ–¥ï¸'
```

---

### 3. æ‰©å±•ç‰¹å¾å·¥ç¨‹

**ä¿®æ”¹**: `nad/ml/feature_engineer.py`

**å˜æ›´**:
- ç‰¹å¾æ•°é‡: 20 â†’ **21**
- æ–°å¢ç‰¹å¾: `device_type` (æ•°å€¼: 0=server_farm, 1=station, 2=iot, 3=external)
- è‡ªåŠ¨ä» IP åœ°å€æå–è®¾å¤‡ç±»å‹

**ç‰¹å¾åˆ—è¡¨**:
```
1-9:   åŸºç¡€ç‰¹å¾ (flow_count, total_bytes, ...)
10-14: è¡ç”Ÿç‰¹å¾ (dst_diversity, ...)
15-19: äºŒå€¼ç‰¹å¾ (is_high_connection, ...)
20:    å¯¹æ•°ç‰¹å¾ (log_flow_count, log_total_bytes)
21:    è®¾å¤‡ç±»å‹ (device_type) â† æ–°å¢
```

---

### 4. è¾“å‡ºæ˜¾ç¤ºä¼˜åŒ–

**ä¿®æ”¹**: `realtime_detection.py`

**æ”¹è¿›**:
- å¼‚å¸¸åˆ—è¡¨æ·»åŠ è®¾å¤‡ç±»å‹å›¾æ ‡åˆ—
- æŒç»­ç›‘æ§æ¨¡å¼æ˜¾ç¤ºè®¾å¤‡ç±»å‹

**ç¤ºä¾‹è¾“å‡º**:
```
æ’å     è¨­å‚™    IPåœ°å€              ç•°å¸¸åˆ†æ•¸         ç½®ä¿¡åº¦        é€£ç·šæ•¸        ç›®çš„åœ°
1      ğŸ–¥ï¸    192.168.10.160     0.6889       0.86       3,264      38
2      ğŸ’»    192.168.20.50      0.6549       0.75       1,258      765
3      ğŸ“¡    192.168.0.4        0.6407       0.69       1,190      4
```

---

### 5. å¼‚å¸¸è®°å½•è‡ªåŠ¨å­˜å‚¨

**æ–°å¢**: `nad/anomaly_logger.py`

**åŠŸèƒ½**:
- è‡ªåŠ¨å°†æ£€æµ‹åˆ°çš„å¼‚å¸¸å†™å…¥ Elasticsearch
- æŒ‰æ—¥æœŸåˆ†ç‰‡ç´¢å¼•: `anomaly_detection-YYYY.MM.DD`
- åŒ…å«è®¾å¤‡ç±»å‹ã€å¨èƒåˆ†ç±»ç­‰å®Œæ•´ä¿¡æ¯
- ä»…åœ¨ `--continuous` æ¨¡å¼ä¸‹è‡ªåŠ¨è®°å½•

**ES ç´¢å¼•ç»“æ„**:
```json
{
  "@timestamp": "2025-11-15T00:00:00Z",
  "src_ip": "192.168.10.160",
  "device_type": "server_farm",
  "anomaly_score": 0.6889,
  "confidence": 0.86,
  "threat_class": "ç¶²è·¯æƒæ",
  "severity": "HIGH",
  ...
}
```

---

## ğŸš€ ä½¿ç”¨è¯´æ˜

### æ–¹æ¡ˆ B (å½“å‰å®æ–½): æ··åˆæ¨¡å‹ + è®¾å¤‡ç±»å‹ç‰¹å¾

#### æ­¥éª¤ 1: é‡æ–°è®­ç»ƒæ¨¡å‹

ç”±äºæ·»åŠ äº†æ–°ç‰¹å¾ï¼ˆ20 â†’ 21ï¼‰ï¼Œéœ€è¦é‡æ–°è®­ç»ƒæ¨¡å‹ï¼š

```bash
# è®­ç»ƒæ–°æ¨¡å‹ï¼ˆåŒ…å« device_type ç‰¹å¾ï¼‰
python3 train_isolation_forest.py --days 7
```

#### æ­¥éª¤ 2: æµ‹è¯•å•æ¬¡æ£€æµ‹

```bash
# æµ‹è¯•æ–°çš„æ˜¾ç¤ºæ ¼å¼ï¼ˆå¸¦è®¾å¤‡ç±»å‹å›¾æ ‡ï¼‰
python3 realtime_detection.py --minutes 30
```

**é¢„æœŸè¾“å‡º**:
- æ¯ä¸ª IP å‰é¢ä¼šæ˜¾ç¤ºè®¾å¤‡ç±»å‹å›¾æ ‡ï¼šğŸ–¥ï¸ğŸ’»ğŸ“¡ğŸŒ
- ç‰¹å¾æ•°é‡å˜ä¸º 21

#### æ­¥éª¤ 3: å¯åŠ¨æŒç»­ç›‘æ§ + è‡ªåŠ¨è®°å½•

```bash
# å¯åŠ¨æŒç»­ç›‘æ§ï¼Œè‡ªåŠ¨è®°å½•å¼‚å¸¸åˆ° ES
python3 realtime_detection.py --continuous --interval 5 --minutes 15 --exclude-servers
```

**åŠŸèƒ½**:
- âœ… æ¯ 5 åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡
- âœ… åˆ†ææœ€è¿‘ 15 åˆ†é’Ÿæ•°æ®
- âœ… è¿‡æ»¤æœåŠ¡å™¨å“åº”æµé‡
- âœ… æ˜¾ç¤ºè®¾å¤‡ç±»å‹å›¾æ ‡
- âœ… è‡ªåŠ¨è®°å½•é«˜ç½®ä¿¡åº¦å¼‚å¸¸åˆ° ES

#### æ­¥éª¤ 4: æŸ¥çœ‹å¼‚å¸¸è®°å½•

```bash
# åœ¨ Kibana ä¸­æŸ¥çœ‹
# ç´¢å¼•æ¨¡å¼: anomaly_detection-*
# æ—¶é—´å­—æ®µ: @timestamp
```

æˆ–ä½¿ç”¨ Python:

```python
from nad.anomaly_logger import AnomalyLogger

logger = AnomalyLogger()

# è·å–æœ€è¿‘ 7 å¤©çš„ç»Ÿè®¡
stats = logger.get_anomaly_stats(days=7)

print(f"æ€»å¼‚å¸¸æ•°: {stats['total']}")
print(f"æŒ‰è®¾å¤‡ç±»å‹: {stats['by_device_type']}")
print(f"æŒ‰å¨èƒç±»åˆ«: {stats['by_threat_class']}")
print(f"Top IP: {stats['top_ips']}")
```

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

### æ–¹æ¡ˆ A vs æ–¹æ¡ˆ B

| é¡¹ç›® | æ–¹æ¡ˆ A (å®Œå…¨åˆ†ç¦») | æ–¹æ¡ˆ B (æ··åˆæ¨¡å‹) | çŠ¶æ€ |
|-----|----------------|----------------|------|
| æ¨¡å‹æ•°é‡ | 3 ä¸ª | 1 ä¸ª | âœ… å·²å®æ–½ |
| ç‰¹å¾æ•°é‡ | 20 | 21 | âœ… å·²å®æ–½ |
| è®­ç»ƒæ—¶é—´ | 3x | 1x | âœ… èŠ‚çœ |
| ç»´æŠ¤æˆæœ¬ | é«˜ | ä½ | âœ… é™ä½ |
| æ£€æµ‹ç²¾åº¦ | æœ€é«˜ | é«˜ | â³ å¾…éªŒè¯ |
| è®¾å¤‡ç±»å‹æ˜¾ç¤º | - | âœ… | âœ… å·²å®æ–½ |
| å¼‚å¸¸è‡ªåŠ¨è®°å½• | - | âœ… | âœ… å·²å®æ–½ |

---

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

### å¦‚æœæ•ˆæœä¸ç†æƒ³ï¼Œå¯å‡çº§åˆ°æ–¹æ¡ˆ A (å®Œå…¨åˆ†ç¦»)

1. **åˆ›å»º 3 ä¸ªç‹¬ç«‹æ¨¡å‹**:
   ```bash
   python3 train_isolation_forest.py --device-type server_farm
   python3 train_isolation_forest.py --device-type station
   python3 train_isolation_forest.py --device-type iot
   ```

2. **ä¿®æ”¹æ£€æµ‹é€»è¾‘**:
   - æ ¹æ® IP é€‰æ‹©å¯¹åº”çš„æ¨¡å‹
   - æ¯ä¸ªæ¨¡å‹ä½¿ç”¨ä¸“é—¨çš„ç‰¹å¾é›†å’Œé˜ˆå€¼

3. **é¢„æœŸæ•ˆæœ**:
   - è¯¯æŠ¥ç‡å¯èƒ½é™ä½ 20-40%
   - ç‰¹åˆ«æ˜¯æœåŠ¡å™¨çš„é«˜æµé‡ä¸å†è¢«è¯¯åˆ¤

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### Elasticsearch æŸ¥è¯¢ç¤ºä¾‹

```json
// æŸ¥è¯¢æœ€è¿‘ 24 å°æ—¶æŒ‰è®¾å¤‡ç±»å‹åˆ†ç»„çš„å¼‚å¸¸æ•°é‡
GET anomaly_detection-*/_search
{
  "query": {
    "range": {
      "@timestamp": {
        "gte": "now-24h"
      }
    }
  },
  "aggs": {
    "by_device_type": {
      "terms": {
        "field": "device_type",
        "size": 10
      },
      "aggs": {
        "avg_score": {
          "avg": {"field": "anomaly_score"}
        }
      }
    }
  }
}
```

---

## âœ¨ æ–°å¢æ–‡ä»¶æ¸…å•

1. âœ… `nad/device_mapping.yaml` - è®¾å¤‡ç±»å‹é…ç½®
2. âœ… `nad/device_classifier.py` - è®¾å¤‡åˆ†ç±»å™¨
3. âœ… `nad/anomaly_logger.py` - å¼‚å¸¸è®°å½•æ—¥å¿—å™¨
4. âœ… `DEVICE_TYPE_FEATURE_README.md` - æœ¬æ–‡æ¡£

## ğŸ› ï¸ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… `nad/ml/feature_engineer.py` - æ·»åŠ  device_type ç‰¹å¾
2. âœ… `realtime_detection.py` - æ˜¾ç¤ºè®¾å¤‡ç±»å‹ + è‡ªåŠ¨è®°å½•å¼‚å¸¸

---

## ğŸ“ è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œè¯·æä¾›ï¼š
- è¯¯æŠ¥/æ¼æŠ¥çš„å…·ä½“æ¡ˆä¾‹
- å„è®¾å¤‡ç±»å‹çš„æ£€æµ‹ç²¾åº¦æ•°æ®
- æ˜¯å¦éœ€è¦å‡çº§åˆ°æ–¹æ¡ˆ A (å®Œå…¨åˆ†ç¦»æ¨¡å‹)

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰**
