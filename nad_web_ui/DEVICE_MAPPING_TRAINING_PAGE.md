# 設備映射配置功能說明（訓練頁面整合版）

## 功能概述

設備映射配置功能已整合到**模型訓練頁面**中，以 Card 形式呈現。管理員可以在訓練模型的同時，方便地管理網路設備的 IP 分類配置。

## 訪問方式

1. 啟動服務後，訪問 http://192.168.10.25:5173
2. 點擊左側導航欄的「**模型訓練**」
3. 向下滾動到「**設備 IP 映射配置**」區塊

## UI 設計

### 緊湊型折疊面板

設備類型以折疊面板（Collapse）形式展示，節省空間：

```
設備 IP 映射配置                    [重新載入]
├─ 🏭 服務器群                      [3 個網段]
│  └─ (展開後顯示詳細資訊)
├─ 💻 工作站                        [3 個網段]
├─ 🛠️ 物聯網設備                   [1 個網段]
└─ 🌐 外部設備                      [0 個網段]
```

### 展開後的設備類型內容

每個設備類型展開後顯示：

1. **說明**：設備類型的描述
2. **IP 網段**：已配置的網段列表（可刪除）
3. **新增網段**：輸入框 + 新增按鈕 + 編輯說明按鈕
4. **特徵**：設備行為特徵標籤

## 功能特點

### 1. **設備類型管理**

四種預設設備類型：

- **🏭 服務器群 (server_farm)**
  - 高入站流量、多並發連線、提供服務端口
  - 預設網段：192.168.10.0/24, 192.168.20.0/24, 192.168.30.0/24

- **💻 工作站 (station)**
  - 主動發起連線、低到中等流量、訪問外部服務
  - 預設網段：192.168.50.0/24, 192.168.60.0/24, 192.168.70.0/24

- **🛠️ 物聯網設備 (iot)**
  - 周期性通信、小流量、特定協議
  - 預設網段：192.168.0.0/24

- **🌐 外部設備 (external)**
  - 外部 IP 或未分類的內部 IP
  - 預設分類、需要人工審查

### 2. **IP 網段管理**

#### 新增網段
1. 點擊設備類型以展開
2. 在「新增網段」輸入框輸入 CIDR 格式（例如：192.168.100.0/24）
3. 點擊「新增網段」按鈕或按 Enter 鍵
4. 系統自動驗證格式並保存

#### 刪除網段
1. 找到要刪除的網段標籤
2. 點擊標籤上的 ✕ 圖示
3. 確認刪除操作
4. 系統自動創建備份並移除網段

### 3. **編輯設備說明**

1. 點擊「編輯說明」按鈕
2. 在對話框中修改：
   - **說明文字**：設備類型的描述
   - **特徵標籤**：可新增/刪除特徵
3. 點擊「保存」完成修改

### 4. **自動備份機制**

每次修改都會自動創建備份：
```
/home/kaisermac/snm_flow/nad/device_mapping.yaml.backup.YYYYMMDD_HHMMSS
```

## 使用場景

### 場景 1：新增內部網段

**情境**：公司新增了一個工作站網段 192.168.80.0/24

**操作步驟**：
1. 訪問訓練頁面
2. 向下滾動到「設備 IP 映射配置」
3. 點擊「💻 工作站」展開
4. 在輸入框輸入：`192.168.80.0/24`
5. 點擊「新增網段」
6. ✅ 完成！

### 場景 2：修改設備說明

**情境**：需要更新服務器群的說明文字

**操作步驟**：
1. 展開「🏭 服務器群」
2. 點擊「編輯說明」按鈕
3. 修改說明文字
4. 可選：新增或刪除特徵標籤
5. 點擊「保存」
6. ✅ 完成！

### 場景 3：清理過期網段

**情境**：某個網段已停用，需要從配置中移除

**操作步驟**：
1. 展開對應的設備類型
2. 找到要移除的網段標籤
3. 點擊標籤上的 ✕
4. 確認刪除
5. ✅ 完成！（系統已自動備份）

## 整合優勢

### 為什麼整合到訓練頁面？

1. **相關性高**：設備映射配置直接影響模型訓練的設備分類功能
2. **集中管理**：模型配置和設備配置在同一頁面，減少頁面切換
3. **操作流程優化**：調整設備配置後可立即重新訓練模型
4. **節省空間**：使用折疊面板，不影響原有訓練配置的可見性

### UI 布局

```
模型訓練頁面
├─ [模型資訊 Card]        (左側)
├─ [訓練配置 Card]        (右側)
├─ [特徵列表 Card]        (全寬，可選顯示)
├─ [訓練進度 Card]        (全寬，訓練時顯示)
└─ [設備 IP 映射配置 Card] (全寬，新增) ← 在這裡！
```

## 後端 API

設備映射功能使用獨立的 API 端點：

### 端點列表

| 方法 | 路徑 | 說明 |
|------|------|------|
| GET | `/api/device-mapping` | 獲取設備映射配置 |
| PUT | `/api/device-mapping/<device_type>` | 更新設備類型配置 |
| POST | `/api/device-mapping/<device_type>/ip-ranges` | 添加 IP 網段 |
| DELETE | `/api/device-mapping/<device_type>/ip-ranges` | 刪除 IP 網段 |

## 配置文件

### 位置
```
/home/kaisermac/snm_flow/nad/device_mapping.yaml
```

### 結構
```yaml
device_types:
  server_farm:
    description: "服務器群，提供各種服務"
    ip_ranges:
      - 192.168.10.0/24
      - 192.168.20.0/24
    characteristics:
      - 高入站流量
      - 多並發連線

  station:
    description: "工作站、PC、筆電"
    ip_ranges:
      - 192.168.50.0/24
    characteristics:
      - 主動發起連線
```

## 技術實現

### 前端實現

**文件**：`frontend/src/views/Training.vue`

**關鍵組件**：
- `el-collapse`：折疊面板容器
- `el-collapse-item`：每個設備類型
- `el-tag`：IP 網段和特徵顯示
- `el-dialog`：編輯說明對話框

**狀態管理**：
```javascript
const deviceTypes = ref(null)           // 設備類型數據
const newIpRanges = ref({})            // 新增網段輸入
const editDeviceDialogVisible = ref(false)  // 對話框顯示狀態
```

**主要函數**：
- `fetchDeviceMapping()`：載入配置
- `handleAddIpRange()`：新增網段
- `handleRemoveIpRange()`：刪除網段
- `saveDeviceType()`：保存編輯

### 後端實現

**服務層**：`backend/services/device_mapping_service.py`
- `DeviceMappingService` 類提供配置管理
- 自動備份功能
- YAML 文件讀寫

**API 層**：`backend/api/device_mapping.py`
- RESTful API 端點
- 請求驗證
- 錯誤處理

## 注意事項

1. **IP 格式**：必須使用 CIDR 格式（例如：192.168.1.0/24）
2. **網段重複**：同一設備類型中不允許重複網段
3. **自動備份**：每次修改都會自動備份，可安全操作
4. **重新載入**：點擊「重新載入」按鈕可刷新最新配置

## 故障排除

### 問題：無法載入設備映射配置

**解決方案**：
1. 檢查後端服務是否正常運行
2. 打開瀏覽器開發者工具，查看 Console 錯誤
3. 確認 `/api/device-mapping` 端點可訪問

### 問題：新增網段失敗

**可能原因**：
1. IP 格式不正確（需要 CIDR 格式）
2. 網段已存在
3. 沒有配置文件寫入權限

**解決方案**：
```bash
# 檢查配置文件權限
ls -l /home/kaisermac/snm_flow/nad/device_mapping.yaml

# 調整權限
chmod 644 /home/kaisermac/snm_flow/nad/device_mapping.yaml
```

### 問題：修改後沒有生效

**解決方案**：
1. 點擊「重新載入」按鈕刷新配置
2. 檢查瀏覽器 Network 標籤，確認 API 請求成功
3. 查看後端日誌：`tail -f backend/logs/backend.log`

## 與模型訓練的整合

設備映射配置會影響：

1. **異常檢測結果**：IP 會被自動分類並顯示對應圖示
2. **訓練數據準備**：可選擇排除特定設備類型
3. **結果分析**：異常按設備類型分組展示

## 測試

### API 測試
```bash
cd /home/kaisermac/nad_web_ui/backend
./test_device_mapping_api.sh
```

### UI 測試
1. 訪問：http://192.168.10.25:5173/training
2. 向下滾動到設備映射配置區塊
3. 測試新增/刪除網段功能
4. 測試編輯說明功能
5. 驗證重新載入功能

## 版本資訊

- **版本**：2.0（整合版）
- **更新日期**：2025-11-17
- **主要變更**：從獨立頁面整合到訓練頁面的 Card 組件

## 未來增強

- [ ] IP 範圍重疊檢測
- [ ] 批量匯入/匯出 IP 配置（CSV）
- [ ] 設備分類統計圖表
- [ ] 配置變更歷史記錄
- [ ] IP 查詢工具（反查所屬設備類型）
