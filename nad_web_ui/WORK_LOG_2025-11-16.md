# 工作日誌 - 2025-11-16

## 概述
本次工作主要針對網路異常檢測系統 (NAD Web UI) 進行多項功能增強，包含 Dashboard 頁面的 Top 10 異常 IP 功能、IP 分析頁面的資訊優化，以及多項使用者體驗改進。

---

## 完成項目

### 1. Dashboard 頁面 - Top 10 異常 IP 功能
**檔案**: `/home/kaisermac/nad_web_ui/frontend/src/views/Dashboard.vue`

#### 功能描述
- 在 Dashboard 頁面的異常檢測結果下方新增 Top 10 異常 IP 列表
- 以「出現次數」為排序依據，顯示在所有時間段中最常出現的異常 IP
- 當使用者點擊特定時間段的 bar 時，隱藏 Top 10 列表，僅顯示該時段的異常 IP
- 提供「返回 Top 10」按鈕，方便使用者切換回總覽視圖

#### 實作細節
**1. 新增計算屬性 `topAnomalousIPs`**
```javascript
const topAnomalousIPs = computed(() => {
  if (!detectionStore.buckets || detectionStore.buckets.length === 0) {
    return []
  }

  // 聚合所有時間段的異常 IP
  const ipMap = new Map()

  detectionStore.buckets.forEach(bucket => {
    bucket.anomalies.forEach(anomaly => {
      const ip = anomaly.src_ip

      if (!ipMap.has(ip)) {
        ipMap.set(ip, {
          src_ip: ip,
          device_emoji: anomaly.device_emoji,
          occurrence_count: 0,
          total_anomaly_score: 0,
          total_confidence: 0,
          total_flow_count: 0,
          threat_class: anomaly.threat_class,
          severity: anomaly.severity,
          unique_dsts: anomaly.unique_dsts
        })
      }

      const ipData = ipMap.get(ip)
      ipData.occurrence_count += 1
      ipData.total_anomaly_score += anomaly.anomaly_score
      ipData.total_confidence += anomaly.confidence
      ipData.total_flow_count += anomaly.flow_count

      // 保留最高嚴重性的威脅分類
      if (!ipData.threat_class ||
          (anomaly.severity === 'HIGH' && ipData.severity !== 'HIGH') ||
          (anomaly.severity === 'MEDIUM' && ipData.severity === 'LOW')) {
        ipData.threat_class = anomaly.threat_class
        ipData.severity = anomaly.severity
      }
    })
  })

  // 轉換為陣列並計算平均值
  const ipList = Array.from(ipMap.values()).map(ip => ({
    ...ip,
    avg_anomaly_score: ip.total_anomaly_score / ip.occurrence_count,
    avg_confidence: ip.total_confidence / ip.occurrence_count
  }))

  // 按出現次數降序排序，取前 10
  return ipList
    .sort((a, b) => b.occurrence_count - a.occurrence_count)
    .slice(0, 10)
})
```

**2. 新增條件渲染邏輯**
- Top 10 列表：只在 `!selectedBucket` 時顯示
- 特定時段列表：只在 `selectedBucket` 存在時顯示

**3. 新增返回功能**
```javascript
function clearSelectedBucket() {
  selectedBucket.value = null
  nextTick(() => {
    scrollToTopIPs()
  })
}
```

**4. 匯入新圖示**
```javascript
import { Back, TrendCharts } from '@element-plus/icons-vue'
```

#### 顯示資訊
Top 10 異常 IP 表格包含以下欄位：
- **排名**: 1-10
- **設備**: Emoji 圖示
- **IP 地址**: 來源 IP
- **出現次數**: 在所有時段中出現的次數 (紅色標籤)
- **平均異常分數**: 所有出現時段的平均異常分數
- **平均置信度**: 百分比顯示
- **威脅類型**: 威脅分類名稱
- **嚴重性**: HIGH/MEDIUM/LOW
- **總連線數**: 累計流量數
- **操作**: 「詳細分析」按鈕

---

### 2. IP 分析頁面 - Top 通訊目的地數量調整
**檔案**: `/home/kaisermac/nad_web_ui/backend/services/analysis_service.py`

#### 修改內容
**位置**: Line 173

**修改前**:
```python
"terms": {"field": "IPV4_DST_ADDR", "size": 20}
```

**修改後**:
```python
"terms": {"field": "IPV4_DST_ADDR", "size": 10}
```

**前端對應修改**: `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`
- 將表格標題從「Top 通訊目的地 (前 20 名)」改為「Top 通訊目的地 (前 10 名)」

---

### 3. IP 分析頁面 - 協定分佈顯示協定名稱
**檔案**: `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`

#### 功能描述
在協定分佈表格中新增「協定名稱」欄位，將 IANA 協定編號轉換為可讀的名稱（如 TCP, UDP, ICMP 等）

#### 實作細節
**1. 新增協定名稱映射函數**
```javascript
function getProtocolName(protocolNumber) {
  const protocols = {
    '1': 'ICMP',
    '6': 'TCP',
    '17': 'UDP',
    '41': 'IPv6',
    '47': 'GRE',
    '50': 'ESP',
    '51': 'AH',
    '58': 'ICMPv6',
    '88': 'EIGRP',
    '89': 'OSPF',
    '103': 'PIM',
    '132': 'SCTP'
  }
  return protocols[protocolNumber] || `Protocol ${protocolNumber}`
}
```

**2. 修改 `getProtocolData()` 函數**
新增 `protocolName` 欄位：
```javascript
return Object.entries(protocolBreakdown)
  .map(([protocol, count]) => ({
    protocol: protocol,
    protocolName: getProtocolName(protocol),  // 新增
    count: count,
    percentage: (count / total) * 100
  }))
  .sort((a, b) => b.count - a.count)
```

**3. 新增表格欄位**
```vue
<el-table-column prop="protocol" label="協定編號" width="100" />
<el-table-column prop="protocolName" label="協定名稱" width="120">
  <template #default="{ row }">
    <el-tag
      :type="row.protocolName === 'TCP' ? 'success' :
             row.protocolName === 'UDP' ? 'warning' : 'info'"
      size="small"
    >
      {{ row.protocolName }}
    </el-tag>
  </template>
</el-table-column>
```

#### 顏色編碼
- **TCP**: 綠色 (success)
- **UDP**: 橙色 (warning)
- **其他**: 藍色 (info)

---

### 4. IP 分析頁面 - 威脅評估顯示檢測時間
**檔案**:
- Backend: `/home/kaisermac/nad_web_ui/backend/services/analysis_service.py`
- Frontend: `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`

#### 後端修改
**位置**: Line 475

新增 `detection_time` 欄位到威脅分類回應：
```python
return {
    'class_name': classification['class_name'],
    'class_name_en': classification['class_name_en'],
    'confidence': classification['confidence'],
    'severity': classification['severity'],
    'severity_emoji': severity_emoji,
    'priority': classification['priority'],
    'description': classification['description'],
    'indicators': classification.get('indicators', [])[:3],
    'response': classification.get('response', [])[:1],
    'detection_time': timestamp.isoformat()  # 添加檢測時間
}
```

#### 前端修改
**1. 新增格式化函數**
```javascript
// 格式化檢測時間（完整格式）
function formatDetectionTime(isoTime) {
  if (!isoTime) return 'N/A'
  const date = new Date(isoTime)
  return date.toLocaleString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  })
}

// 格式化檢測時間範圍（10分鐘時段）
function formatDetectionTimeRange(isoTime) {
  if (!isoTime) return ''
  const startTime = new Date(isoTime)
  const endTime = new Date(startTime.getTime() + 10 * 60 * 1000) // +10分鐘

  const formatTime = (date) => {
    return date.toLocaleString('zh-TW', {
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  return `10分鐘時段: ${formatTime(startTime)} ~ ${formatTime(endTime)}`
}
```

**2. 威脅評估區塊新增檢測時間欄位**
```vue
<el-descriptions-item label="檢測時間" :span="2">
  <el-tag type="info" size="large">
    {{ formatDetectionTime(results.threat_classification.detection_time) }}
  </el-tag>
</el-descriptions-item>
```

**3. 流量統計摘要標題新增時段標籤**
```vue
<span>
  <el-icon><DataLine /></el-icon>
  流量統計摘要
  <el-tag
    v-if="results.threat_classification"
    type="info"
    size="small"
    style="margin-left: 8px"
  >
    {{ formatDetectionTimeRange(results.threat_classification.detection_time) }}
  </el-tag>
</span>
```

#### 顯示效果
- **威脅評估**: 顯示完整檢測時間 (例: 2025/11/16 14:35:00)
- **流量統計摘要**: 顯示 10 分鐘時段範圍 (例: 10分鐘時段: 11/16 14:35 ~ 14:45)

---

### 5. IP 分析頁面 - 不重複目的地顯示優化
**檔案**: `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`

#### 問題描述
使用者發現「不重複目的地」顯示的數字與實際 Top 10 列表不一致：
- 顯示「8 IPs」但列表有 10 個 IP
- 原因：數據來自不同索引
  - `unique_destinations`: 來自 `netflow_stats_5m` 聚合索引的 cardinality 統計
  - `top_destinations`: 來自 `radar_flow_collector-*` 原始流量記錄的 terms 聚合

#### 初步方案 (已放棄)
嘗試新增 Info Icon 顯示目的地 IP 列表，但因為數據來源不一致導致顯示邏輯複雜且容易混淆

#### 最終方案
**簡化為標準 el-statistic 元件**，直接使用聚合統計數據：

```vue
<el-col :span="6">
  <el-statistic
    title="不重複目的地"
    :value="getUniqueDestinationsCount()"
    :precision="0"
  >
    <template #suffix>IPs</template>
  </el-statistic>
</el-col>
```

```javascript
function getUniqueDestinationsCount() {
  if (!results.value) return 0
  return results.value.summary?.unique_destinations || 0
}
```

#### 數據來源說明
- 使用 `summary.unique_destinations`，此數據來自 `netflow_stats_5m` 聚合索引
- 反映該 IP 在統計時段內實際通訊過的不重複目的地數量
- 可能與 Top 10 列表數量不同，因為：
  - Top 10 僅顯示前 10 名
  - 原始索引可能因清理政策導致部分歷史數據缺失
  - 聚合統計使用 cardinality 近似計算

---

## 技術要點

### 1. Vue 3 Composition API 使用
- `ref`: 響應式變數
- `computed`: 計算屬性（如 Top 10 IP 聚合）
- `watch`: 監聽數據變化
- `nextTick`: DOM 更新後執行操作
- `onMounted`: 組件掛載時執行

### 2. Element Plus 組件應用
- `el-card`: 卡片容器
- `el-table`: 資料表格（含排序、固定欄位）
- `el-tag`: 標籤顯示（含類型顏色編碼）
- `el-divider`: 分隔線
- `el-statistic`: 統計數字顯示
- `el-button`: 操作按鈕
- `el-icon`: 圖示系統

### 3. ECharts 互動
- 點擊事件綁定: `myChart.on('click', handleBarClick)`
- 資料同步更新

### 4. Elasticsearch 查詢優化
- 調整 aggregation size 參數控制返回數量
- 理解不同索引的資料特性（聚合 vs 原始）

### 5. 時間格式化
- ISO 8601 格式處理
- 台灣繁體中文本地化 (`zh-TW`)
- 時間範圍計算（+10 分鐘）

---

## 資料流說明

### Dashboard Top 10 IP 計算流程
```
Pinia Store (detectionStore.buckets)
  ↓
遍歷所有時間段 (forEach bucket)
  ↓
遍歷每個時段的異常 IP (forEach anomaly)
  ↓
使用 Map 聚合相同 IP 的數據
  - occurrence_count: 出現次數 +1
  - total_anomaly_score: 累計異常分數
  - total_confidence: 累計置信度
  - total_flow_count: 累計流量數
  - threat_class/severity: 保留最高嚴重性
  ↓
計算平均值
  - avg_anomaly_score = total / count
  - avg_confidence = total / count
  ↓
排序（依 occurrence_count 降序）並取前 10
```

### IP 分析資料來源
```
Backend: analysis_service.py
  ├─ _get_summary_from_aggregated()
  │   → netflow_stats_5m (聚合索引)
  │   → 返回 summary.unique_destinations (cardinality)
  │
  ├─ _get_details_from_raw()
  │   → radar_flow_collector-* (原始流量)
  │   → 返回 top_destinations (terms, size=10)
  │
  └─ _classify_threat()
      → 返回 threat_classification.detection_time
```

---

## 檔案變更清單

### Backend
1. `/home/kaisermac/nad_web_ui/backend/services/analysis_service.py`
   - Line 173: 修改 top_dsts size 從 20 → 10
   - Line 475: 新增 detection_time 欄位

### Frontend
1. `/home/kaisermac/nad_web_ui/frontend/src/views/Dashboard.vue`
   - 新增 computed property: `topAnomalousIPs`
   - 新增 function: `clearSelectedBucket()`
   - 新增 imports: `Back`, `TrendCharts` 圖示
   - 新增 template: Top 10 異常 IP 表格
   - 修改 template: 條件渲染邏輯 (`v-if="!selectedBucket"`)

2. `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`
   - 新增 function: `getProtocolName()`
   - 新增 function: `formatDetectionTime()`
   - 新增 function: `formatDetectionTimeRange()`
   - 簡化 function: `getUniqueDestinationsCount()`
   - 修改 function: `getProtocolData()` (新增 protocolName 欄位)
   - 修改 template: 協定分佈表格（新增協定名稱欄位）
   - 修改 template: 威脅評估（新增檢測時間）
   - 修改 template: 流量統計摘要（新增時段標籤）
   - 修改 template: 不重複目的地（簡化為標準 el-statistic）
   - 修改文字: Top 通訊目的地 (前 20 名) → (前 10 名)
   - 移除: InfoFilled 圖示 import

---

## 測試建議

### Dashboard 頁面
1. ✅ 頁面載入時顯示 Top 10 異常 IP
2. ✅ Top 10 列表正確按出現次數排序
3. ✅ 點擊 bar chart 後 Top 10 列表隱藏
4. ✅ 顯示「返回 Top 10」按鈕
5. ✅ 點擊「返回 Top 10」後恢復顯示並自動滾動
6. ✅ 「詳細分析」按鈕正確導航到 IP 分析頁面

### IP 分析頁面
1. ✅ Top 通訊目的地顯示 10 筆資料
2. ✅ 協定分佈表格顯示協定名稱
3. ✅ TCP/UDP/ICMP 等常見協定正確識別
4. ✅ 協定名稱標籤顏色正確（TCP 綠色、UDP 橙色）
5. ✅ 威脅評估顯示檢測時間（完整日期時間）
6. ✅ 流量統計摘要顯示 10 分鐘時段範圍
7. ✅ 不重複目的地顯示正確數值（來自聚合統計）
8. ✅ 時間格式使用台灣繁體中文格式

---

## 已知問題與限制

### 1. 資料來源不一致
**現象**: `unique_destinations` 與 `top_destinations` 列表數量可能不同

**原因**:
- `unique_destinations`: 來自 `netflow_stats_5m` 聚合索引，使用 cardinality 近似計算
- `top_destinations`: 來自 `radar_flow_collector-*` 原始流量，使用 terms 精確統計前 10 名
- 原始流量索引可能因保留政策導致部分歷史資料已清理

**影響**: 使用者可能看到「不重複目的地: 8 IPs」但 Top 10 列表顯示 10 筆記錄

**解決方案**:
- 已移除容易造成混淆的 Info Icon
- 使用聚合統計作為標準數據來源
- 建議在文件中說明兩者的差異

### 2. 協定名稱映射
**限制**: 僅涵蓋常見協定 (ICMP, TCP, UDP, IPv6, GRE, ESP, AH, ICMPv6, EIGRP, OSPF, PIM, SCTP)

**未知協定**: 顯示為 `Protocol {編號}`

**建議**: 若需支援更多協定，可擴充 `getProtocolName()` 函數的映射表

---

## 使用者回饋與改進

### 已採納的建議
1. ✅ Top 10 列表以出現次數排序（而非異常分數）
2. ✅ 點擊 bar 時隱藏 Top 10，避免資訊過載
3. ✅ 提供「返回 Top 10」按鈕，改善導航體驗
4. ✅ 協定分佈顯示人類可讀的名稱
5. ✅ 威脅評估顯示檢測時間，增加透明度
6. ✅ 流量統計標示時段範圍，避免混淆
7. ✅ 移除容易產生誤解的 Info Icon

### 使用者反應
- 資料來源不一致問題經討論後理解原因
- 最終採用簡化方案，避免複雜的前端邏輯
- 強調使用台灣用語（「埠」而非「端口」）

---

## 術語規範

為確保介面一致性，所有文字均使用台灣繁體中文術語：

| 英文 | 台灣用語 | ❌ 避免使用 |
|------|---------|-----------|
| Port | 埠 | 端口 |
| Server | 伺服器 | 服務器 |
| Network | 網路 | 网络 |
| Packet | 封包 | 数据包 |
| Flow | 流量 | 流 |

---

## 部署注意事項

### 前端 (Vite HMR)
- 修改會自動熱重載，無需手動重啟
- 建議清除瀏覽器快取以確保載入最新版本

### 後端 (Flask Debug Mode)
- 修改會自動重載，無需手動重啟
- 檢查終端確認重載成功

### 相依套件
**無新增套件**，所有功能使用現有依賴：
- Vue 3
- Element Plus
- ECharts
- Pinia
- Python: elasticsearch, openai, ipwhois

---

## 未來改進建議

### 1. 資料一致性優化
- 考慮統一使用聚合索引或原始索引作為單一數據來源
- 若保留雙源，需在 UI 明確標示數據來源差異

### 2. 協定映射擴充
- 擴充協定映射表至 IANA 完整列表
- 考慮從後端提供協定映射，避免前端維護

### 3. 時間範圍靈活性
- 目前 10 分鐘時段為固定值，未來可改為可配置參數
- 支援自訂時間範圍查詢

### 4. Top N 可配置
- 允許使用者自訂 Top N 數量（如 5, 10, 20）
- 儲存使用者偏好設定

### 5. 效能優化
- Top 10 計算目前在前端進行，若資料量大可考慮後端預先計算
- 新增分頁功能以支援更大的資料集

### 6. 匯出功能
- 支援 CSV/Excel 匯出 Top 10 異常 IP 報表
- 支援 PDF 匯出完整分析報告

---

## 參考資料

### IANA Protocol Numbers
- https://www.iana.org/assignments/protocol-numbers/protocol-numbers.xhtml

### Element Plus Documentation
- Table: https://element-plus.org/en-US/component/table.html
- Tag: https://element-plus.org/en-US/component/tag.html
- Statistic: https://element-plus.org/en-US/component/statistic.html

### Vue 3 Composition API
- https://vuejs.org/guide/extras/composition-api-faq.html

### Elasticsearch Aggregations
- Terms Aggregation: https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html
- Cardinality Aggregation: https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-cardinality-aggregation.html

---

## 工作時間記錄
- **日期**: 2025-11-16
- **總計**: 約 10 項功能修改與優化
- **主要檔案**: 3 個（2 個前端、1 個後端）
- **程式碼行數**: 約 200+ 行新增/修改

---

## 下午/晚間工作項目 (續)

### 6. IP 分析頁面 - 修正置信度顯示問題
**時間**: 19:05-19:35
**檔案**:
- Backend: `/home/kaisermac/nad_web_ui/backend/services/analysis_service.py`
- Frontend: `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`

#### 問題描述
使用者發現威脅評估顯示置信度 50%，懷疑有誤，因為系統設定只有異常置信度 > 60% 的 IP 才會被存入 ES。

#### 根本原因分析
系統實際上有**兩種置信度**：
1. **異常檢測置信度 (anomaly_confidence)**: Isolation Forest ML 模型的異常檢測置信度（通常 > 60%，例如 75%）
2. **威脅分類置信度 (threat_confidence)**: 對異常流量進行威脅類型分類的置信度（「未知異常」通常為 50%）

原先前端只顯示威脅分類置信度，導致使用者誤解。

#### 解決方案
**1. 後端修改** (Line 465-550)
從 `anomaly_detection-*` 索引讀取已存在的威脅分類時，同時回傳兩種置信度：

```python
return {
    'class_name': anomaly_record.get('threat_class'),
    'class_name_en': anomaly_record.get('threat_class_en'),
    'confidence': anomaly_record.get('threat_confidence', 0.5),  # 威脅分類置信度
    'anomaly_confidence': anomaly_record.get('confidence', 0.0),  # NEW: Isolation Forest 置信度
    # ... 其他欄位
}
```

**2. 前端修改** (Line 160-278)
新增兩個置信度欄位並加上說明性的 Info Icon：

```vue
<!-- 異常置信度 (Isolation Forest) -->
<el-descriptions-item v-if="results.threat_classification.anomaly_confidence">
  <template #label>
    異常置信度
    <el-tooltip effect="dark" placement="top">
      <template #content>
        <strong>Isolation Forest 異常檢測置信度</strong><br/>
        只有 > 60% 的異常流量會被系統記錄。
      </template>
      <el-icon><InfoFilled /></el-icon>
    </el-tooltip>
  </template>
  <el-tag type="success" size="large">
    {{ (results.threat_classification.anomaly_confidence * 100).toFixed(1) }}%
  </el-tag>
</el-descriptions-item>

<!-- 威脅分類置信度 -->
<el-descriptions-item>
  <template #label>
    威脅分類置信度
    <el-tooltip effect="dark" placement="top">
      <template #content>
        表示系統對此異常流量的威脅類型判斷的確定程度。<br/>
        50% 通常表示「未知異常」，需要人工進一步分析。
      </template>
      <el-icon><InfoFilled /></el-icon>
    </el-tooltip>
  </template>
  <el-progress :percentage="(results.threat_classification.confidence * 100)" />
</el-descriptions-item>
```

#### 教育性說明
新增了詳細的 Tooltip 說明，解釋：
- 兩階段檢測機制
- 異常檢測置信度與威脅分類置信度的差異
- 為什麼「未知異常」顯示 50%（表示無法確定具體威脅類型）

---

### 7. IP 分析頁面 - UI 卡片順序重組
**時間**: 19:36-19:50
**檔案**: `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`

#### 問題描述
使用者指出 UI 邏輯順序不當：
- 原順序：基本資訊 → 威脅評估（含行為特徵）→ 流量統計
- 問題：行為特徵檢測應該在威脅評估**之前**，因為這是實際的檢測流程

#### 解決方案
重新組織卡片順序，符合實際檢測流程：

**新順序**:
1. **基本資訊卡** (IP、設備類型、查詢時間範圍)
2. **步驟 1: 異常行為特徵檢測** (Line 105-158) - 新增獨立卡片
   - 顯示 Isolation Forest 偵測到的異常行為
   - 說明只有置信度 > 60% 才會進入下一階段
3. **步驟 2: 威脅評估與分類** (Line 160-278) - 調整後的卡片
   - 顯示威脅類型、嚴重性
   - 顯示兩種置信度
   - 移除行為特徵（已移至步驟 1）
4. **流量統計摘要**
5. **Top 通訊目的地**
6. **埠號分佈**
7. **協定分佈**

#### 實作細節
**步驟 1 卡片程式碼**:
```vue
<!-- 步驟1: 異常行為特徵檢測 -->
<el-card v-if="results.behavior_analysis?.behaviors?.length" shadow="never" class="behavior-card">
  <template #header>
    <div class="card-header">
      <span>
        <el-icon><DataLine /></el-icon>
        步驟 1：異常行為特徵檢測
        <el-tooltip effect="dark" placement="top" raw-content>
          <template #content>
            <div style="max-width: 400px;">
              <p><strong>Isolation Forest 異常檢測</strong></p>
              <p>使用 Isolation Forest 機器學習演算法分析流量行為模式，檢測出與正常行為顯著不同的流量。</p>
              <p>只有異常置信度 > 60% 的流量會被記錄並進入下一階段的威脅分類。</p>
            </div>
          </template>
          <el-icon style="margin-left: 4px; cursor: help; color: #409eff;">
            <InfoFilled />
          </el-icon>
        </el-tooltip>
      </span>
    </div>
  </template>
  <el-alert title="偵測到異常流量行為" type="warning" :closable="false">
    <el-space wrap>
      <el-tag v-for="behavior in results.behavior_analysis.behaviors" :key="behavior" type="warning" size="large">
        {{ behavior }}
      </el-tag>
    </el-space>
  </el-alert>
</el-card>
```

**步驟 2 卡片標題更新**:
```vue
<el-icon><Warning /></el-icon>
步驟 2：威脅評估與分類
<el-tooltip effect="dark" placement="top" raw-content>
  <template #content>
    <div style="max-width: 400px;">
      <p><strong>威脅分類與風險評估</strong></p>
      <p>針對步驟 1 偵測到的異常流量，進一步分析其威脅類型、嚴重性和建議處置方式。</p>
      <p><strong>兩種置信度的意義：</strong></p>
      <ul>
        <li><strong>異常置信度</strong>: Isolation Forest 判斷此流量為異常的信心程度</li>
        <li><strong>威脅分類置信度</strong>: 系統判斷威脅類型的信心程度（50% 通常表示「未知異常」）</li>
      </ul>
    </div>
  </template>
  <el-icon style="margin-left: 4px; cursor: help; color: #409eff;">
    <InfoFilled />
  </el-icon>
</el-tooltip>
```

#### 使用者體驗改善
- ✅ 符合實際檢測邏輯流程
- ✅ 清楚說明兩階段檢測機制
- ✅ 每個步驟都有詳細的 Tooltip 說明
- ✅ 視覺上更容易理解系統運作方式

---

### 8. IP 分析頁面 - 實作自動模式 (Auto Mode)
**時間**: 19:48-19:53
**檔案**:
- Backend: `/home/kaisermac/nad_web_ui/backend/services/analysis_service.py`
- Backend API: `/home/kaisermac/nad_web_ui/backend/api/analysis.py`
- Frontend: `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`

#### 功能需求
使用者希望支援「自動模式」：
- 不需要手動指定 `top_n=20`
- 自動依照「不重複目的地」的實際 IP 數量來決定要顯示多少筆資料

#### 實作方案

**1. 後端 API 修改** (`api/analysis.py` Line 70, 79-84)
```python
top_n = data.get('top_n')  # top_n 參數，如果未提供則為 None（自動模式）

# 驗證 top_n（如果有提供）
if top_n is not None and not (1 <= top_n <= 100):  # 自動模式最多 100 筆
    return jsonify({
        'status': 'error',
        'error': 'top_n must be between 1 and 100'
    }), 400
```

**2. 後端服務修改** (`analysis_service.py` Line 189-206)
```python
def _get_details_from_raw(self, ip: str, start_time: str, end_time: str, top_n: int = None) -> Dict:
    """從原始索引獲取詳細資訊

    Args:
        ip: IP 地址
        start_time: 開始時間
        end_time: 結束時間
        top_n: 返回前 N 筆資料（None = 返回所有）
    """
    # 如果 top_n 為 None（自動模式），設定一個較大的值來獲取所有資料
    if top_n is None:
        top_n = 1000  # 臨時設為較大值，ES 會自動返回實際不重複的數量
        top_n_ports = 1000
    else:
        top_n_ports = top_n
```

**3. 前端修改** (Line 792-855)
```javascript
// mounted 時的處理
onMounted(() => {
  if (route.query.ip) {
    ipAddress.value = route.query.ip
    if (route.query.minutes) {
      minutes.value = parseInt(route.query.minutes)
    }
    // 如果沒有提供 top_n，設為 null（自動模式）
    if (route.query.top_n) {
      topN.value = parseInt(route.query.top_n)
    } else {
      topN.value = null  // 自動模式
    }
    handleAnalyze()
  }
})

// 分析函數
async function handleAnalyze() {
  // ... 省略驗證邏輯

  const requestData = {
    ip: ipAddress.value,
    minutes: minutes.value
  }

  // 只有在指定 top_n 時才傳遞
  if (topN.value !== null) {
    requestData.top_n = topN.value
  }

  const { data } = await analysisAPI.analyzeIP(requestData)

  if (data.status === 'success') {
    results.value = data

    // 自動模式：根據 unique_destinations 設定 topN
    if (topN.value === null && data.summary?.unique_destinations) {
      topN.value = data.summary.unique_destinations
    }
  }
}
```

#### 使用方式
```
# 手動模式（指定數量）
http://192.168.10.25:5173/analysis?ip=192.168.10.160&minutes=1440&top_n=20

# 自動模式（不指定 top_n）
http://192.168.10.25:5173/analysis?ip=192.168.10.160&minutes=1440
```

#### 優點
- ✅ 不需要猜測應該顯示多少筆資料
- ✅ 自動適應實際的目的地數量
- ✅ 避免顯示過多或過少的資料
- ✅ 向後相容（仍可手動指定 top_n）

---

### 9. IP 分析頁面 - 修正不重複目的地計數錯誤
**時間**: 19:54-20:30
**檔案**: `/home/kaisermac/nad_web_ui/backend/services/analysis_service.py`

#### 問題描述
```
使用者回報：
URL: http://192.168.10.25:5173/analysis?ip=192.168.10.160&minutes=1440
顯示：不重複目的地 16IPs
但是：Top 通訊目的地表格卻列出了 54 個 IP
```

#### 根本原因分析
檢查 `_get_summary_from_aggregated()` 方法 (Line 128-187)，發現問題：

**錯誤的查詢邏輯**:
```python
"aggs": {
    "unique_dsts": {
        "cardinality": {"field": "unique_dsts"}  # ❌ 錯誤！
    }
}
```

**問題**:
- `unique_dsts` 欄位本身已經是一個**數字**（在 `netflow_stats_5m` 中預先計算的不重複目的地數量）
- 對一個數字欄位做 cardinality 聚合是沒有意義的
- 應該對**原始的 IP 地址欄位** (`IPV4_DST_ADDR`) 做 cardinality

#### 解決方案
修改 `_get_summary_from_aggregated()` 方法，改為查詢**原始索引**來取得真實的 cardinality：

```python
def _get_summary_from_aggregated(self, ip: str, start_time: str, end_time: str) -> Dict:
    # ... 先從聚合索引取得統計資料
    response = self.es.search(index="netflow_stats_5m", body=query)

    # 從原始索引查詢真實的不重複數量
    cardinality_query = {
        "size": 0,
        "query": {
            "bool": {
                "filter": [
                    {"match_phrase": {"IPV4_SRC_ADDR": ip}},
                    {"range": {
                        "FLOW_START_MILLISECONDS": {
                            "gte": start_time,
                            "lte": end_time,
                            "format": "strict_date_optional_time"
                        }
                    }}
                ]
            }
        },
        "aggs": {
            "unique_dsts": {
                "cardinality": {"field": "IPV4_DST_ADDR"}  # ✅ 正確：對 IP 欄位做 cardinality
            },
            "unique_src_ports": {
                "cardinality": {"field": "L4_SRC_PORT"}
            },
            "unique_dst_ports": {
                "cardinality": {"field": "L4_DST_PORT"}
            }
        }
    }

    cardinality_resp = self.es.search(index="radar_flow_collector-*", body=cardinality_query)

    return {
        # ... 使用聚合索引的統計資料
        'total_flows': total_flows,
        'total_bytes': total_bytes,
        'total_packets': total_packets,

        # ✅ 使用原始索引的真實 cardinality
        'unique_destinations': cardinality_resp['aggregations']['unique_dsts']['value'],
        'unique_src_ports': cardinality_resp['aggregations']['unique_src_ports']['value'],
        'unique_dst_ports': cardinality_resp['aggregations']['unique_dst_ports']['value'],

        # ... 其他欄位
    }
```

#### 修正結果
- ✅ 「不重複目的地」現在顯示真實的 unique IP count
- ✅ 與 Top 通訊目的地表格的數量一致（自動模式下）
- ✅ 同時修正了來源埠和目的埠的計數

#### 技術細節
**為什麼需要查詢兩個索引？**
1. **`netflow_stats_5m` (聚合索引)**:
   - 提供預先計算的統計資料（total_flows, total_bytes, total_packets）
   - 查詢速度快，適合取得總量數據

2. **`radar_flow_collector-*` (原始索引)**:
   - 保留原始的 NetFlow 記錄
   - 可以對實際的 IP 地址、埠號欄位做 cardinality 聚合
   - 提供真實的不重複計數

---

### 10. IP 分析頁面 - 修正顯示標籤使用實際計數
**時間**: 20:31-20:35
**檔案**: `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`

#### 問題描述
```
使用者回報：
URL: http://192.168.10.25:5173/analysis?ip=192.168.10.160&minutes=1440
顯示：Top 目的埠號分佈 (前 54 名)
實際：只有 6 個不重複埠號
```

#### 根本原因
- 標籤使用了 `topN` 變數（在自動模式下會被設為 unique_destinations 的數量）
- 應該使用實際的**埠號數量**或**目的地數量**

#### 解決方案

**1. 修正 Top 通訊目的地標籤** (Line 367)
```vue
<!-- 修改前 -->
<h3>🎯 Top 通訊目的地 (前 {{ topN }} 名)</h3>

<!-- 修改後 -->
<h3>🎯 Top 通訊目的地 (前 {{ results.details.top_destinations.length }} 名)</h3>
```

**2. 修正 Top 目的埠號標籤** (Line 404)
```vue
<!-- 修改前 -->
<h3>🔌 Top 目的埠號分佈 (前 {{ topN }} 名)</h3>

<!-- 修改後 -->
<h3>🔌 Top 目的埠號分佈 (前 {{ Object.keys(results.details.port_distribution || {}).length }} 名)</h3>
```

**3. 修正 PDF 生成區段的標籤** (Line 628, 653)
```vue
<!-- Top 通訊目的地 -->
<h2>🎯 Top {{ results.details.top_destinations.length }} 通訊目的地</h2>

<!-- Top 目的埠號 -->
<h2>🔌 Top {{ Object.keys(results.details.port_distribution || {}).length }} 目的埠號</h2>
```

#### 修正結果
- ✅ 標籤正確顯示實際的資料筆數
- ✅ 避免混淆（不再使用 topN 變數）
- ✅ PDF 匯出也使用正確的計數

---

## 技術重點 (下午/晚間)

### 1. 兩階段異常檢測機制
```
Stage 1: Isolation Forest 異常檢測
  ↓ (只有 confidence > 60% 才會進入)
Stage 2: 威脅類型分類
  ↓
產生兩種置信度:
  - anomaly_confidence: ML 模型的異常檢測信心
  - threat_confidence: 威脅類型分類信心
```

### 2. Elasticsearch 資料來源策略
```
聚合索引 (netflow_stats_5m):
  ✅ 適合: 總流量、總位元組、總封包數
  ❌ 不適合: Cardinality 計算 (unique IPs, unique ports)

原始索引 (radar_flow_collector-*):
  ✅ 適合: Cardinality、Terms 聚合
  ❌ 不適合: 大量資料的全掃描
```

### 3. 自動模式實作模式
```javascript
// 參數處理
top_n = None  // 後端不限制數量

// ES 查詢
"size": 1000  // 設定較大值，ES 會返回實際不重複數量

// 前端顯示
topN = summary.unique_destinations  // 使用實際計數
```

### 4. UI/UX 改善原則
- **邏輯順序**: UI 順序應符合實際系統運作流程
- **透明度**: 使用 Info Icon 解釋複雜概念
- **一致性**: 標籤應使用實際資料計數，避免使用變數
- **自動化**: 減少使用者需要手動配置的參數

---

## 檔案變更清單 (下午/晚間)

### Backend
1. `/home/kaisermac/nad_web_ui/backend/services/analysis_service.py`
   - Line 128-187: 修正 `_get_summary_from_aggregated()` - 查詢原始索引取得真實 cardinality
   - Line 189-206: 修改 `_get_details_from_raw()` - 支援 top_n=None 自動模式
   - Line 465-550: 修改 `_classify_threat()` - 新增 anomaly_confidence 欄位

2. `/home/kaisermac/nad_web_ui/backend/api/analysis.py`
   - Line 70: top_n 參數改為 optional (None = 自動模式)
   - Line 79-84: top_n 驗證改為只在有提供時才驗證

### Frontend
1. `/home/kaisermac/nad_web_ui/frontend/src/views/IPAnalysis.vue`
   - Line 105-158: 新增步驟 1 卡片（異常行為特徵檢測）
   - Line 160-278: 調整步驟 2 卡片（威脅評估）- 新增兩種置信度顯示
   - Line 367: 修正 Top 通訊目的地標籤
   - Line 404: 修正 Top 目的埠號標籤
   - Line 628, 653: 修正 PDF 區段標籤
   - Line 792-855: 實作自動模式邏輯

---

## 測試紀錄 (下午/晚間)

### 測試案例
**URL**: `http://192.168.10.25:5173/analysis?ip=192.168.10.160&minutes=1440`

#### 測試結果
1. ✅ 異常置信度顯示 > 60% (例如 73.9%)
2. ✅ 威脅分類置信度正確顯示 (例如 50% for Unknown Anomaly)
3. ✅ 卡片順序符合檢測流程 (行為檢測 → 威脅評估)
4. ✅ 自動模式正確取得所有目的地 IP
5. ✅ 不重複目的地計數正確 (與表格數量一致)
6. ✅ Top 通訊目的地標籤顯示實際筆數
7. ✅ Top 目的埠號標籤顯示實際筆數 (6 個埠)
8. ✅ 所有 Info Icon 提供清晰說明
9. ✅ 排序依照流量數 (flow_count) 降序

### 後端日誌
```
DEBUG: 從 ES 讀取到最近異常記錄，time_bucket=2025-11-16T11:35:00.000Z, confidence=0.7393242090574272
127.0.0.1 - - [16/Nov/2025 19:53:17] "POST /api/analysis/ip HTTP/1.1" 200 -
```

---

## 使用者反饋處理

### Issue #1: 置信度 50% 疑問
**回報**: "出現置信度50%，這是很奇怪的因為 超過60%, 該IP 才會存到ES 中"
**處理**:
- ✅ 釐清兩種置信度的差異
- ✅ 新增 UI 說明區分兩者
- ✅ 保留兩種置信度都顯示，增加透明度

### Issue #2: UI 順序邏輯
**回報**: "應該要在威脅評估之前 [顯示行為特徵]"
**處理**:
- ✅ 重組卡片順序
- ✅ 建立步驟 1、步驟 2 的明確區分
- ✅ 新增說明解釋檢測流程

### Issue #3: 自動模式需求
**回報**: "可否支援自動模式，不需要top_n=20，而由'不重複目的地'的IP數來決定"
**處理**:
- ✅ 實作後端 top_n=None 支援
- ✅ 前端自動偵測並設定
- ✅ 保持向後相容

### Issue #4: 數量不一致
**回報**: "不重複目的地 16IPs，Top 通訊目的地 (前 16 名) 表格卻是一路列了54 個IP"
**處理**:
- ✅ 修正 cardinality 計算邏輯
- ✅ 從原始索引取得正確計數
- ✅ 自動模式確保一致性

### Issue #5: 標籤顯示錯誤
**回報**: "Top 目的埠號分佈 (前 54 名) 這裡不應該顯示前54"
**處理**:
- ✅ 修正所有標籤使用實際計數
- ✅ 避免使用 topN 變數
- ✅ PDF 區段同步修正

### Issue #6: 排序方式確認
**詢問**: "Top 通訊目的地 (前 54 名) 的排序是依照什麼？"
**回答**:
- ✅ 確認排序依照流量數 (flow_count)
- ✅ 解釋 ES terms aggregation 預設行為
- ✅ 使用者確認維持現有排序

---

## 已知限制與說明 (補充)

### 1. 兩種置信度的必要性
- **異常檢測**: 偵測「這是異常流量嗎？」
- **威脅分類**: 分析「這是什麼類型的威脅？」
- 兩者獨立運作，置信度不一定相同

### 2. 原始索引與聚合索引的差異
- **原始索引可能被清理**: 保留政策可能刪除較舊的資料
- **聚合索引保留更久**: 統計資料較持久
- **建議**: 重要分析應在資料清理前完成

### 3. Cardinality 聚合的近似性
- Elasticsearch cardinality 使用 HyperLogLog++ 演算法
- 對於大量資料是近似值，不是精確值
- 誤差通常 < 5%，可接受

---

## 簽核
- **開發者**: Claude Code (Anthropic AI Assistant)
- **審核者**: 待使用者確認
- **狀態**: ✅ 已完成並測試 (更新至 20:35)
- **工作時段**: 上午 + 下午/晚間 (19:05-20:35)

---

*本文件由 Claude Code 自動生成，記錄 NAD Web UI 專案的開發工作內容*
