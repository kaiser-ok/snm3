<template>
  <div class="training">
    <el-row :gutter="20">
      <!-- æ¨¡å‹è³‡è¨Š -->
      <el-col :span="12">
        <el-card shadow="never">
          <template #header>
            <div style="display: flex; align-items: center; gap: 8px;">
              <span>æ¨¡å‹è³‡è¨Š</span>
              <el-tooltip
                placement="right"
                raw-content
              >
                <template #content>
                  <div style="max-width: 500px; line-height: 1.8;">
                    <h3 style="color: #409EFF; margin: 0 0 12px 0; font-size: 16px;">ğŸŒ² Isolation Forest ç•°å¸¸åµæ¸¬æ©Ÿåˆ¶èªªæ˜</h3>

                    <div style="margin-bottom: 16px; padding: 10px; background-color: #f0f9ff; border-left: 3px solid #409EFF; color: #303133;">
                      <strong>æ ¸å¿ƒæ¦‚å¿µï¼š</strong><br/>
                      ä¸€ç¨®åŸºæ–¼æ¨¹ç‹€çµæ§‹çš„ç„¡ç›£ç£å¼æ©Ÿå™¨å­¸ç¿’æ¼”ç®—æ³•ï¼Œå°ˆé–€ç”¨æ–¼ç•°å¸¸æª¢æ¸¬ã€‚<br/>
                      åŸç†æ˜¯ã€Œç•°å¸¸é»å®¹æ˜“è¢«éš”é›¢ã€â€”â€” èˆ‡æ­£å¸¸é»ç›¸æ¯”ï¼Œç•°å¸¸é»åœ¨ç‰¹å¾µç©ºé–“ä¸­è¼ƒå­¤ç«‹ï¼Œ<br/>
                      å› æ­¤éœ€è¦è¼ƒå°‘æ¬¡æ•¸çš„éš¨æ©Ÿåˆ†å‰²å°±èƒ½è¢«éš”é›¢å‡ºä¾†ã€‚
                    </div>

                    <strong>ğŸ¯ åµæ¸¬åŸç†ï¼š</strong><br/>
                    â€¢ <strong>æ­£å¸¸æ•¸æ“šé»ï¼š</strong>èšé›†åœ¨ä¸€èµ·ï¼Œéœ€è¦å¾ˆå¤šæ¬¡åˆ†å‰²æ‰èƒ½è¢«éš”é›¢ï¼ˆè·¯å¾‘é•·ï¼‰<br/>
                    â€¢ <strong>ç•°å¸¸æ•¸æ“šé»ï¼š</strong>é é›¢æ­£å¸¸ç¾¤é«”ï¼Œå¾ˆå¿«å°±è¢«éš”é›¢ï¼ˆè·¯å¾‘çŸ­ï¼‰<br/>
                    â€¢ <strong>ç•°å¸¸åˆ†æ•¸ï¼š</strong>æ ¹æ“šå¹³å‡è·¯å¾‘é•·åº¦è¨ˆç®—ï¼Œè·¯å¾‘è¶ŠçŸ­åˆ†æ•¸è¶Šé«˜<br/><br/>

                    <strong>ğŸ“Š æ¼”ç®—æ³•æ­¥é©Ÿï¼š</strong><br/>
                    1ï¸âƒ£ å¾è¨“ç·´è³‡æ–™ä¸­éš¨æ©ŸæŠ½æ¨£<br/>
                    2ï¸âƒ£ å»ºç«‹å¤šæ£µéš¨æ©Ÿæ±ºç­–æ¨¹ï¼ˆIsolation Treeï¼‰<br/>
                    3ï¸âƒ£ è¨ˆç®—æ¯å€‹æ•¸æ“šé»åœ¨æ‰€æœ‰æ¨¹ä¸­çš„å¹³å‡è·¯å¾‘é•·åº¦<br/>
                    4ï¸âƒ£ è·¯å¾‘é•·åº¦çŸ­çš„é»è¢«åˆ¤å®šç‚ºç•°å¸¸<br/><br/>

                    <h3 style="color: #67C23A; margin: 16px 0 12px 0; font-size: 16px;">ğŸŒ³ Random Decision Treeï¼ˆéš¨æ©Ÿæ±ºç­–æ¨¹ï¼‰</h3>

                    <div style="margin-bottom: 16px; padding: 10px; background-color: #f0f9f0; border-left: 3px solid #67C23A; color: #303133;">
                      <strong>å®šç¾©ï¼š</strong><br/>
                      Isolation Forest çš„åŸºæœ¬çµ„æˆå–®å…ƒã€‚ä¸åŒæ–¼å‚³çµ±æ±ºç­–æ¨¹ï¼Œ<br/>
                      é€™è£¡çš„æ¨¹ä½¿ç”¨<strong>éš¨æ©Ÿç‰¹å¾µ</strong>å’Œ<strong>éš¨æ©Ÿåˆ†å‰²é»</strong>ä¾†å»ºç«‹ï¼Œ<br/>
                      ç›®çš„æ˜¯å°‡æ•¸æ“šé»é€æ­¥éš”é›¢ï¼Œè€Œéåˆ†é¡ã€‚
                    </div>

                    <strong>ğŸ”§ å»ºæ§‹æ–¹å¼ï¼š</strong><br/>
                    â€¢ <strong>éš¨æ©Ÿé¸æ“‡ç‰¹å¾µï¼š</strong>å¾æ‰€æœ‰ç‰¹å¾µä¸­éš¨æ©ŸæŒ‘é¸ä¸€å€‹<br/>
                    â€¢ <strong>éš¨æ©Ÿé¸æ“‡åˆ†å‰²å€¼ï¼š</strong>åœ¨è©²ç‰¹å¾µçš„æœ€å¤§æœ€å°å€¼é–“éš¨æ©Ÿé¸æ“‡<br/>
                    â€¢ <strong>éè¿´åˆ†å‰²ï¼š</strong>æŒçºŒåˆ†å‰²ç›´åˆ°æ¯å€‹é»è¢«éš”é›¢æˆ–é”åˆ°æ¨¹æ·±åº¦ä¸Šé™<br/>
                    â€¢ <strong>ç„¡éœ€æ¨™ç±¤ï¼š</strong>è¨“ç·´éç¨‹å®Œå…¨ä¸éœ€è¦æ¨™è¨˜ç•°å¸¸/æ­£å¸¸<br/><br/>

                    <strong>ğŸŒ² ç‚ºä»€éº¼éœ€è¦å¤šæ£µæ¨¹ï¼ˆæ£®æ—ï¼‰ï¼Ÿ</strong><br/>
                    â€¢ <strong>é™ä½éš¨æ©Ÿæ€§ï¼š</strong>å–®æ£µæ¨¹çš„éš¨æ©Ÿåˆ†å‰²å¯èƒ½ä¸æº–ç¢º<br/>
                    â€¢ <strong>æé«˜ç©©å®šæ€§ï¼š</strong>å¤šæ£µæ¨¹çš„å¹³å‡çµæœæ›´å¯é <br/>
                    â€¢ <strong>å¢åŠ è¦†è“‹ç‡ï¼š</strong>ä¸åŒçš„æ¨¹åœ¨ä¸åŒç¶­åº¦éš”é›¢ç•°å¸¸é»<br/>
                    â€¢ <strong>æ¸›å°‘èª¤åˆ¤ï¼š</strong>é›†æˆå­¸ç¿’ï¼ˆEnsembleï¼‰é™ä½åå·®<br/><br/>

                    <div style="margin-top: 16px; padding: 10px; background-color: #fff7e6; border-left: 3px solid #E6A23C; color: #303133;">
                      <strong>ğŸ’¡ å¯¦éš›æ‡‰ç”¨é¡æ¯”ï¼š</strong><br/>
                      å°±åƒç”¨å¤šå€‹ä¸åŒè§’åº¦çš„æ¨™æº–ä¾†åˆ¤æ–·ä¸€å€‹äººæ˜¯å¦ç•°å¸¸ï¼š<br/>
                      å–®ä¸€æ¨™æº–å¯èƒ½æœ‰åè¦‹ï¼Œä½†ç¶œåˆå¤šå€‹ç¨ç«‹åˆ¤æ–·ï¼Œçµæœæ›´æº–ç¢ºå¯é ã€‚
                    </div>

                    <div style="margin-top: 16px; padding: 8px; background-color: #fef0f0; border-left: 3px solid #F56C6C; color: #303133;">
                      <strong>âš¡ æ¼”ç®—æ³•å„ªå‹¢ï¼š</strong><br/>
                      âœ“ ç„¡éœ€æ¨™è¨˜è³‡æ–™ï¼ˆç„¡ç›£ç£å­¸ç¿’ï¼‰<br/>
                      âœ“ è¨“ç·´å’Œé æ¸¬é€Ÿåº¦å¿«<br/>
                      âœ“ è¨˜æ†¶é«”å ç”¨å°<br/>
                      âœ“ å°é«˜ç¶­åº¦è³‡æ–™æ•ˆæœå¥½<br/>
                      âœ“ å¯è™•ç†å¤§è¦æ¨¡è³‡æ–™é›†
                    </div>
                  </div>
                </template>
                <el-icon style="cursor: help; color: #409EFF;">
                  <InfoFilled />
                </el-icon>
              </el-tooltip>
            </div>
          </template>

          <div v-if="trainingStore.config" class="model-info">
            <el-descriptions :column="1" border>
              <el-descriptions-item label="æ¨¡å‹ç‹€æ…‹">
                <el-tag :type="getStatusTagType(trainingStore.config.model_info?.status)">
                  {{ getModelStatusText(trainingStore.config.model_info?.status) }}
                </el-tag>
              </el-descriptions-item>
              <el-descriptions-item label="è¨“ç·´æ—¥æœŸ" v-if="trainingStore.config.model_info?.trained_at">
                {{ formatTrainedDate(trainingStore.config.model_info.trained_at) }}
              </el-descriptions-item>
              <el-descriptions-item label="ç‰¹å¾µæ•¸é‡">
                <div v-if="trainingStore.config.model_info?.n_features" style="display: flex; align-items: center; gap: 8px;">
                  <span>{{ trainingStore.config.model_info.n_features }}</span>
                  <el-button
                    v-if="trainingStore.config.model_info?.feature_names"
                    size="small"
                    text
                    @click="showFeatures = !showFeatures"
                  >
                    {{ showFeatures ? 'éš±è—ç‰¹å¾µ' : 'æŸ¥çœ‹ç‰¹å¾µ' }}
                  </el-button>
                </div>
                <el-text v-else type="info">ç„¡æ³•å–å¾—</el-text>
              </el-descriptions-item>
              <el-descriptions-item>
                <template #label>
                  <span>æ±ºç­–æ¨¹æ•¸é‡</span>
                  <el-tooltip
                    placement="top"
                    raw-content
                  >
                    <template #content>
                      <div style="max-width: 300px;">
                        ç”¨æ–¼è¨“ç·´çš„æ±ºç­–æ¨¹ç¸½æ•¸<br/>
                        æ•¸é‡è¶Šå¤šæª¢æ¸¬è¶Šç©©å®šä½†è¨“ç·´æ™‚é–“è¶Šé•·
                      </div>
                    </template>
                    <el-icon style="margin-left: 4px; cursor: help;">
                      <InfoFilled />
                    </el-icon>
                  </el-tooltip>
                </template>
                <span v-if="trainingStore.config.model_info?.status === 'trained'">
                  {{ trainingStore.config.model_info.n_estimators }}
                </span>
                <span v-else>
                  {{ trainingStore.config.training_config?.n_estimators }}ï¼ˆé…ç½®å€¼ï¼‰
                </span>
              </el-descriptions-item>
              <el-descriptions-item>
                <template #label>
                  <span>æ±¡æŸ“ç‡</span>
                  <el-tooltip
                    placement="top"
                    raw-content
                  >
                    <template #content>
                      <div style="max-width: 350px;">
                        <strong>å®šç¾©ï¼š</strong>é æœŸè³‡æ–™ä¸­ç•°å¸¸æ¯”ä¾‹çš„ä¼°è¨ˆå€¼<br/><br/>
                        <strong>ä½œç”¨ï¼š</strong>å½±éŸ¿ç•°å¸¸åˆ†æ•¸çš„åˆ¤å®šé–¾å€¼<br/>
                        â€¢ 0.05 (5%)ï¼šé æœŸ 5% çš„æµé‡æ˜¯ç•°å¸¸ï¼ˆå¸¸ç”¨å€¼ï¼‰<br/>
                        â€¢ æ•¸å€¼è¶Šé«˜ï¼šåˆ¤å®šè¶Šå¯¬é¬†ï¼Œæ›´å¤šæµé‡è¢«æ¨™è¨˜ç‚ºç•°å¸¸<br/>
                        â€¢ æ•¸å€¼è¶Šä½ï¼šåˆ¤å®šè¶Šåš´æ ¼ï¼Œåªæœ‰æ¥µç«¯ç•°å¸¸æ‰æœƒè¢«æ¨™è¨˜<br/><br/>
                        <strong>å»ºè­°ï¼š</strong>æ ¹æ“šç¶²è·¯ç’°å¢ƒèª¿æ•´ï¼Œä¸€èˆ¬è¨­å®š 0.01-0.10
                      </div>
                    </template>
                    <el-icon style="margin-left: 4px; cursor: help;">
                      <InfoFilled />
                    </el-icon>
                  </el-tooltip>
                </template>
                <span v-if="trainingStore.config.model_info?.status === 'trained'">
                  {{ trainingStore.config.model_info.contamination }}
                </span>
                <span v-else>
                  {{ trainingStore.config.training_config?.contamination }}ï¼ˆé…ç½®å€¼ï¼‰
                </span>
              </el-descriptions-item>
            </el-descriptions>
          </div>
        </el-card>
      </el-col>

      <!-- è¨“ç·´é…ç½® -->
      <el-col :span="12">
        <el-card shadow="never">
          <template #header>
            <span>è¨“ç·´é…ç½®</span>
          </template>

          <el-form label-position="top">
            <!-- ä½¿ç”¨å…©æ¬„å¸ƒå±€ -->
            <el-row :gutter="16">
              <el-col :span="12">
                <el-form-item label="è¨“ç·´è³‡æ–™å¤©æ•¸">
                  <el-input-number
                    v-model="trainingDays"
                    :min="1"
                    :max="14"
                    style="width: 100%;"
                  />
                </el-form-item>
              </el-col>

              <el-col :span="12">
                <el-form-item>
                  <template #label>
                    <span>æ±ºç­–æ¨¹æ•¸é‡</span>
                    <el-tooltip placement="top" raw-content>
                      <template #content>
                        <div style="max-width: 300px;">
                          Isolation Forest ä½¿ç”¨çš„æ±ºç­–æ¨¹ç¸½æ•¸<br/>
                          â€¢ 100-150ï¼šå¿«é€Ÿè¨“ç·´<br/>
                          â€¢ 150-200ï¼šå¹³è¡¡æ•ˆèƒ½ï¼ˆæ¨è–¦ï¼‰<br/>
                          â€¢ 200-300ï¼šæœ€é«˜æº–ç¢ºåº¦
                        </div>
                      </template>
                      <el-icon style="margin-left: 4px; cursor: help;">
                        <InfoFilled />
                      </el-icon>
                    </el-tooltip>
                  </template>
                  <el-input-number
                    v-model="nEstimators"
                    :min="50"
                    :max="300"
                    :step="10"
                    style="width: 100%;"
                  />
                </el-form-item>
              </el-col>
            </el-row>

            <el-row :gutter="16">
              <el-col :span="12">
                <el-form-item>
                  <template #label>
                    <span>æ±¡æŸ“ç‡</span>
                    <el-tooltip placement="top" raw-content>
                      <template #content>
                        <div style="max-width: 300px;">
                          é æœŸè³‡æ–™ä¸­ç•°å¸¸æ¯”ä¾‹<br/>
                          â€¢ 0.01-0.03ï¼šåš´æ ¼<br/>
                          â€¢ 0.05ï¼šå¹³è¡¡ï¼ˆæ¨è–¦ï¼‰<br/>
                          â€¢ 0.08-0.10ï¼šå¯¬é¬†
                        </div>
                      </template>
                      <el-icon style="margin-left: 4px; cursor: help;">
                        <InfoFilled />
                      </el-icon>
                    </el-tooltip>
                  </template>
                  <el-input-number
                    v-model="contamination"
                    :min="0.01"
                    :max="0.10"
                    :step="0.01"
                    :precision="2"
                    style="width: 100%;"
                  />
                </el-form-item>
              </el-col>

              <el-col :span="12">
                <el-form-item>
                  <template #label>
                    <span>ç•°å¸¸åµæ¸¬é–¾å€¼</span>
                    <el-tooltip placement="top" raw-content>
                      <template #content>
                        <div style="max-width: 300px;">
                          æ§åˆ¶å³æ™‚åµæ¸¬éˆæ•åº¦<br/>
                          â€¢ 0.3-0.5ï¼šé«˜éˆæ•åº¦<br/>
                          â€¢ 0.6ï¼šå¹³è¡¡ï¼ˆæ¨è–¦ï¼‰<br/>
                          â€¢ 0.7-0.9ï¼šä½éˆæ•åº¦
                        </div>
                      </template>
                      <el-icon style="margin-left: 4px; cursor: help;">
                        <InfoFilled />
                      </el-icon>
                    </el-tooltip>
                  </template>
                  <el-input-number
                    v-model="anomalyThreshold"
                    :min="0.1"
                    :max="1.0"
                    :step="0.1"
                    :precision="1"
                    style="width: 100%;"
                  />
                </el-form-item>
              </el-col>
            </el-row>

            <el-form-item>
              <template #label>
                <span>æ’é™¤ä¼ºæœå™¨å›æ‡‰æµé‡</span>
                <el-tooltip placement="top" raw-content>
                  <template #content>
                    <div style="max-width: 300px;">
                      éæ¿¾ä¼ºæœå™¨å›æ‡‰æµé‡ï¼Œ<br/>
                      å°ˆæ³¨åˆ†æå®¢æˆ¶ç«¯ç•°å¸¸è¡Œç‚º
                    </div>
                  </template>
                  <el-icon style="margin-left: 4px; cursor: help;">
                    <InfoFilled />
                  </el-icon>
                </el-tooltip>
              </template>
              <el-switch v-model="excludeServers" />
            </el-form-item>

            <!-- æ“ä½œæŒ‰éˆ• -->
            <el-divider style="margin: 16px 0;" />
            <el-row :gutter="12">
              <el-col :span="12">
                <el-button
                  @click="resetToDefaults"
                  :icon="RefreshLeft"
                  size="large"
                  style="width: 100%;"
                >
                  æ¢å¾©é è¨­å€¼
                </el-button>
              </el-col>
              <el-col :span="12">
                <el-button
                  type="primary"
                  @click="handleStartTraining"
                  :loading="trainingStore.training"
                  :icon="VideoPlay"
                  size="large"
                  style="width: 100%;"
                >
                  é–‹å§‹è¨“ç·´
                </el-button>
              </el-col>
            </el-row>
          </el-form>
        </el-card>
      </el-col>
    </el-row>

    <!-- ç‰¹å¾µåˆ—è¡¨ -->
    <el-card v-if="showFeatures && trainingStore.config?.model_info?.feature_names" shadow="never" class="features-card">
      <template #header>
        <div class="card-header">
          <span>ç‰¹å¾µå·¥ç¨‹åˆ—è¡¨ï¼ˆ{{ trainingStore.config.model_info.feature_names.length }} å€‹ç‰¹å¾µï¼‰</span>
        </div>
      </template>

      <div class="features-grid">
        <el-tag
          v-for="(feature, index) in trainingStore.config.model_info.feature_names"
          :key="index"
          class="feature-tag"
          type="info"
        >
          {{ index + 1 }}. {{ feature }}
        </el-tag>
      </div>
    </el-card>

    <!-- è¨“ç·´é€²åº¦ -->
    <el-card v-if="trainingStore.training || trainingStore.progress.percent > 0" shadow="never" class="progress-card">
      <template #header>
        <span>è¨“ç·´é€²åº¦</span>
      </template>

      <div class="progress-content">
        <el-progress
          :percentage="trainingStore.progress.percent"
          :status="trainingStore.progress.percent === 100 ? 'success' : undefined"
        />
        <p class="progress-message">{{ trainingStore.progress.message }}</p>
      </div>
    </el-card>

    <!-- ç¶²æ®µè¨­å‚™é…ç½® -->
    <el-card shadow="never" class="device-mapping-card">
      <template #header>
        <div class="card-header">
          <span>
            ç¶²æ®µè¨­å‚™é…ç½®
            <el-tooltip
              placement="top"
              raw-content
            >
              <template #content>
                <div style="max-width: 400px;">
                  æ­¤è¨­å®šç”¨æ–¼æ¨™ç¤ºå„ç¶²æ®µçš„å¯¦éš›ç”¨é€”å’Œè¨­å‚™é¡å‹<br/>
                  å¯å”åŠ©ç³»çµ±åœ¨è¨“ç·´æ¨¡å‹æ™‚æ›´ç²¾æº–åœ°è¾¨è­˜ä¸åŒè¨­å‚™çš„æ­£å¸¸è¡Œç‚ºæ¨¡å¼<br/><br/>
                  <strong>è¨­å®šé …ç›®ï¼š</strong><br/>
                  â€¢ IP ç¶²æ®µï¼šå®šç¾©è¨­å‚™é¡å‹çš„ IP ç¯„åœ<br/>
                  â€¢ ç‰¹å¾µï¼šæè¿°è©²é¡å‹è¨­å‚™çš„ç¶²è·¯è¡Œç‚ºç‰¹æ€§<br/>
                  â€¢ èªªæ˜ï¼šè¨­å‚™é¡å‹çš„ç”¨é€”èªªæ˜
                </div>
              </template>
              <el-icon style="margin-left: 4px; cursor: help;">
                <InfoFilled />
              </el-icon>
            </el-tooltip>
          </span>
          <div>
            <el-button
              size="small"
              type="primary"
              @click="openCreateDeviceTypeDialog"
              :icon="Plus"
            >
              æ–°å¢è¨­å‚™é¡åˆ¥
            </el-button>
            <el-button
              size="small"
              @click="refreshDeviceMapping"
              :icon="Refresh"
              :loading="deviceMappingLoading"
            >
              é‡æ–°è¼‰å…¥
            </el-button>
          </div>
        </div>
      </template>

      <!-- é‡è¦æé†’ -->
      <el-alert
        type="warning"
        :closable="false"
        style="margin-bottom: 16px;"
      >
        <template #title>
          é‡è¦æé†’
        </template>
        æ–°å¢ã€åˆªé™¤æˆ–é‡å‘½åè¨­å‚™é¡å‹å¾Œï¼Œéœ€è¦<strong>é‡æ–°è¨“ç·´æ¨¡å‹</strong>æ‰èƒ½ç”Ÿæ•ˆã€‚<br/>
        è¨­å‚™é¡å‹è®Šæ›´æœƒå½±éŸ¿æ¨¡å‹ç‰¹å¾µç·¨ç¢¼ï¼ŒèˆŠæ¨¡å‹å°‡ç„¡æ³•ä½¿ç”¨ã€‚
      </el-alert>

      <div v-if="deviceTypes" class="device-types-compact">
        <el-collapse accordion>
          <el-collapse-item
            v-for="(typeData, typeName) in deviceTypes"
            :key="typeName"
            :name="typeName"
          >
            <template #title>
              <div class="device-type-title">
                <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                  <span class="type-icon">{{ typeData.icon }}</span>
                  <strong>{{ typeData.display_name || getDeviceTypeName(typeName) }}</strong>
                  <el-tag size="small">
                    {{ typeData.ip_ranges ? typeData.ip_ranges.length : 0 }} å€‹ç¶²æ®µ
                  </el-tag>
                  <el-tag size="small" type="info" v-if="isProtectedType(typeName)">
                    é è¨­
                  </el-tag>
                </div>
                <div style="display: flex; gap: 4px;" @click.stop>
                  <el-button
                    size="small"
                    @click="openEditDeviceTypeDialog(typeName)"
                    :icon="Edit"
                  >
                    ç·¨è¼¯é¡åˆ¥
                  </el-button>
                  <el-button
                    size="small"
                    type="danger"
                    @click="handleDeleteDeviceType(typeName)"
                    :icon="Delete"
                    :disabled="isProtectedType(typeName)"
                  >
                    åˆªé™¤
                  </el-button>
                </div>
              </div>
            </template>

            <div class="device-type-content">
              <div class="description" style="margin-bottom: 12px;">
                <strong>èªªæ˜ï¼š</strong>{{ typeData.description }}
              </div>

              <div class="ip-ranges-section">
                <strong>IP ç¶²æ®µï¼š</strong>
                <div v-if="typeData.ip_ranges && typeData.ip_ranges.length > 0" class="range-list">
                  <el-tag
                    v-for="(range, idx) in typeData.ip_ranges"
                    :key="idx"
                    closable
                    @close="handleRemoveIpRange(typeName, range)"
                    style="margin: 4px;"
                  >
                    {{ range }}
                  </el-tag>
                </div>
                <el-text v-else type="info">å°šç„¡è¨­å®š</el-text>
              </div>

              <div class="add-range-section" style="margin-top: 12px;">
                <el-input
                  v-model="newIpRanges[typeName]"
                  placeholder="ä¾‹å¦‚: 192.168.1.0/24"
                  size="small"
                  style="width: 200px; margin-right: 8px;"
                  @keyup.enter="handleAddIpRange(typeName)"
                />
                <el-button
                  type="primary"
                  size="small"
                  @click="handleAddIpRange(typeName)"
                  :icon="Plus"
                >
                  æ–°å¢ç¶²æ®µ
                </el-button>
                <el-button
                  size="small"
                  @click="openEditDeviceDialog(typeName)"
                  :icon="Edit"
                  style="margin-left: 8px;"
                >
                  ç·¨è¼¯èªªæ˜
                </el-button>
              </div>

              <div class="characteristics-section" style="margin-top: 12px;">
                <strong>ç‰¹å¾µï¼š</strong>
                <el-tag
                  v-for="(char, idx) in typeData.characteristics"
                  :key="idx"
                  type="info"
                  size="small"
                  style="margin: 4px;"
                >
                  {{ char }}
                </el-tag>
              </div>
            </div>
          </el-collapse-item>
        </el-collapse>
      </div>

      <div v-else style="text-align: center; padding: 20px; color: #909399;">
        è¼‰å…¥ä¸­...
      </div>
    </el-card>

    <!-- æ–°å¢/ç·¨è¼¯è¨­å‚™é¡å‹å°è©±æ¡† -->
    <el-dialog
      v-model="deviceTypeDialogVisible"
      :title="isEditingDeviceType ? 'ç·¨è¼¯è¨­å‚™é¡åˆ¥' : 'æ–°å¢è¨­å‚™é¡åˆ¥'"
      width="600px"
    >
      <el-form label-position="top" v-if="deviceTypeFormData">
        <el-form-item label="é¡åˆ¥ Key" :required="!isEditingDeviceType">
          <el-input
            v-model="deviceTypeFormData.type_key"
            placeholder="ä¾‹å¦‚: database, web_server"
            :disabled="isEditingDeviceType"
          />
          <div class="form-item-tip">
            è‹±æ–‡ã€æ•¸å­—ã€åº•ç·šï¼Œç”¨æ–¼ç¨‹å¼è­˜åˆ¥ï¼ˆæ–°å¢å¾Œä¸å¯ä¿®æ”¹ï¼‰
          </div>
        </el-form-item>

        <el-form-item label="é¡¯ç¤ºåç¨±" required>
          <el-input
            v-model="deviceTypeFormData.display_name"
            placeholder="ä¾‹å¦‚: è³‡æ–™åº«ä¼ºæœå™¨"
          />
        </el-form-item>

        <el-form-item label="åœ–ç¤º">
          <div style="display: flex; align-items: center; gap: 8px;">
            <el-input
              v-model="deviceTypeFormData.icon"
              placeholder="é¸æ“‡æˆ–è¼¸å…¥ emoji"
              style="width: 120px;"
            />
            <div class="icon-picker">
              <el-button
                v-for="icon in commonIcons"
                :key="icon"
                size="small"
                @click="deviceTypeFormData.icon = icon"
                :type="deviceTypeFormData.icon === icon ? 'primary' : ''"
              >
                {{ icon }}
              </el-button>
            </div>
          </div>
        </el-form-item>

        <el-form-item label="èªªæ˜">
          <el-input
            v-model="deviceTypeFormData.description"
            type="textarea"
            :rows="2"
            placeholder="è¨­å‚™é¡å‹çš„æè¿°"
          />
        </el-form-item>

        <el-form-item label="ç‰¹å¾µ">
          <!-- å·²é¸ç‰¹å¾µ -->
          <div v-if="deviceTypeFormData.characteristics.length > 0" style="margin-bottom: 12px;">
            <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">å·²é¸ç‰¹å¾µï¼š</div>
            <el-tag
              v-for="(char, idx) in deviceTypeFormData.characteristics"
              :key="idx"
              closable
              @close="deviceTypeFormData.characteristics.splice(idx, 1)"
              style="margin: 4px;"
              type="success"
            >
              {{ char }}
            </el-tag>
          </div>

          <!-- é è¨­ç‰¹å¾µé¸æ“‡ -->
          <div class="characteristics-selector">
            <div
              v-for="(category, key) in predefinedCharacteristics"
              :key="key"
              class="characteristic-category"
            >
              <div class="category-title">{{ category.name }}</div>
              <div class="characteristic-options">
                <el-checkbox
                  v-for="item in category.items"
                  :key="item"
                  :label="item"
                  :model-value="deviceTypeFormData.characteristics.includes(item)"
                  @change="toggleCharacteristic(item, $event)"
                  size="small"
                >
                  {{ item }}
                </el-checkbox>
              </div>
            </div>
          </div>

          <!-- è‡ªè¨‚ç‰¹å¾µ -->
          <div style="margin-top: 12px;">
            <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">è‡ªè¨‚ç‰¹å¾µï¼š</div>
            <el-input
              v-model="newDeviceTypeCharacteristic"
              placeholder="è¼¸å…¥è‡ªè¨‚ç‰¹å¾µä¸¦æŒ‰ Enter"
              style="width: 250px;"
              size="small"
              @keyup.enter="addDeviceTypeCharacteristic"
            >
              <template #append>
                <el-button @click="addDeviceTypeCharacteristic" :icon="Plus">æ–°å¢</el-button>
              </template>
            </el-input>
          </div>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="deviceTypeDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveDeviceTypeChanges">å­˜æª”</el-button>
      </template>
    </el-dialog>

    <!-- åŸç·¨è¼¯èªªæ˜å°è©±æ¡†ï¼ˆç”¨æ–¼å¿«é€Ÿç·¨è¼¯ï¼‰ -->
    <el-dialog
      v-model="editDeviceDialogVisible"
      :title="`ç·¨è¼¯è¨­å‚™èªªæ˜ï¼š${currentEditDeviceType}`"
      width="600px"
    >
      <el-form label-position="top" v-if="editDeviceFormData">
        <el-form-item label="åœ–ç¤º">
          <el-input
            v-model="editDeviceFormData.icon"
            placeholder="è¼¸å…¥ emoji åœ–ç¤º"
            maxlength="2"
            style="width: 100px;"
          />
        </el-form-item>
        <el-form-item label="èªªæ˜">
          <el-input
            v-model="editDeviceFormData.description"
            type="textarea"
            :rows="2"
          />
        </el-form-item>
        <el-form-item label="ç‰¹å¾µ">
          <!-- å·²é¸ç‰¹å¾µ -->
          <div v-if="editDeviceFormData.characteristics.length > 0" style="margin-bottom: 12px;">
            <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">å·²é¸ç‰¹å¾µï¼š</div>
            <el-tag
              v-for="(char, idx) in editDeviceFormData.characteristics"
              :key="idx"
              closable
              @close="removeDeviceCharacteristic(idx)"
              style="margin: 4px;"
              type="success"
            >
              {{ char }}
            </el-tag>
          </div>

          <!-- é è¨­ç‰¹å¾µé¸æ“‡ -->
          <div class="characteristics-selector">
            <div
              v-for="(category, key) in predefinedCharacteristics"
              :key="key"
              class="characteristic-category"
            >
              <div class="category-title">{{ category.name }}</div>
              <div class="characteristic-options">
                <el-checkbox
                  v-for="item in category.items"
                  :key="item"
                  :label="item"
                  :model-value="editDeviceFormData.characteristics.includes(item)"
                  @change="toggleEditCharacteristic(item, $event)"
                  size="small"
                >
                  {{ item }}
                </el-checkbox>
              </div>
            </div>
          </div>

          <!-- è‡ªè¨‚ç‰¹å¾µ -->
          <div style="margin-top: 12px;">
            <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">è‡ªè¨‚ç‰¹å¾µï¼š</div>
            <el-input
              v-model="newDeviceCharacteristic"
              placeholder="è¼¸å…¥è‡ªè¨‚ç‰¹å¾µä¸¦æŒ‰ Enter"
              style="width: 250px;"
              size="small"
              @keyup.enter="addDeviceCharacteristic"
            >
              <template #append>
                <el-button @click="addDeviceCharacteristic" :icon="Plus">æ–°å¢</el-button>
              </template>
            </el-input>
          </div>
        </el-form-item>
      </el-form>
      <template #footer>
        <el-button @click="editDeviceDialogVisible = false">å–æ¶ˆ</el-button>
        <el-button type="primary" @click="saveDeviceType">å­˜æª”</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useTrainingStore } from '@/stores/training'
import { VideoPlay, InfoFilled, RefreshLeft, Refresh, Plus, Edit, Delete } from '@element-plus/icons-vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import axios from 'axios'

const trainingStore = useTrainingStore()

// é è¨­å€¼å¸¸æ•¸
const DEFAULT_VALUES = {
  trainingDays: 3,
  nEstimators: 150,
  contamination: 0.05,
  anomalyThreshold: 0.6,
  excludeServers: false
}

const trainingDays = ref(DEFAULT_VALUES.trainingDays)
const nEstimators = ref(DEFAULT_VALUES.nEstimators)
const contamination = ref(DEFAULT_VALUES.contamination)
const anomalyThreshold = ref(DEFAULT_VALUES.anomalyThreshold)
const excludeServers = ref(DEFAULT_VALUES.excludeServers)
const showFeatures = ref(false)

// è¨­å‚™æ˜ å°„ç›¸é—œ
const deviceMappingLoading = ref(false)
const deviceTypes = ref(null)
const newIpRanges = ref({})
const editDeviceDialogVisible = ref(false)
const currentEditDeviceType = ref('')
const editDeviceFormData = ref(null)
const newDeviceCharacteristic = ref('')

// æ–°å¢/ç·¨è¼¯è¨­å‚™é¡å‹
const deviceTypeDialogVisible = ref(false)
const isEditingDeviceType = ref(false)
const deviceTypeFormData = ref(null)
const newDeviceTypeCharacteristic = ref('')

// å¸¸ç”¨åœ–ç¤º
const commonIcons = ['ğŸ­', 'ğŸ’»', 'ğŸ› ï¸', 'ğŸŒ', 'ğŸ–¥ï¸', 'ğŸ“±', 'ğŸ”§', 'âš™ï¸', 'ğŸ—„ï¸', 'ğŸ“¡', 'ğŸŒŸ', 'ğŸ“¦']

// é è¨­é¡å‹ï¼ˆå—ä¿è­·ï¼‰
const protectedTypes = ['server_farm', 'station', 'iot', 'external']

// é è¨­ç‰¹å¾µæ¨™ç±¤åº«
const predefinedCharacteristics = {
  traffic: {
    name: 'æµé‡ç‰¹å¾µ',
    items: ['é«˜å…¥ç«™æµé‡', 'é«˜å‡ºç«™æµé‡', 'ä½æµé‡', 'ä¸­ç­‰æµé‡', 'å°æµé‡', 'é€±æœŸæ€§æµé‡']
  },
  connection: {
    name: 'é€£ç·šç‰¹å¾µ',
    items: ['ä¸»å‹•ç™¼èµ·é€£ç·š', 'è¢«å‹•æ¥å—é€£ç·š', 'å¤šä¸¦ç™¼é€£ç·š', 'æŒä¹…é€£ç·š', 'çŸ­æš«é€£ç·š']
  },
  behavior: {
    name: 'è¡Œç‚ºç‰¹å¾µ',
    items: ['æä¾›æœå‹™ç«¯å£', 'è¨ªå•å¤–éƒ¨æœå‹™', 'é€±æœŸæ€§é€šä¿¡', 'è³‡æ–™å‚™ä»½', 'é«˜ç£ç¢Ÿ I/O', 'ç‰¹å®šå”è­°']
  },
  security: {
    name: 'å®‰å…¨ç‰¹å¾µ',
    items: ['éœ€è¦äººå·¥å¯©æŸ¥', 'é è¨­åˆ†é¡', 'å—ç®¡æ§è¨­å‚™', 'é—œéµè¨­å‚™']
  }
}

const deviceTypeNameMap = {
  'server_farm': 'æœå‹™å™¨ç¾¤',
  'station': 'å·¥ä½œç«™',
  'iot': 'ç‰©è¯ç¶²è¨­å‚™',
  'external': 'å¤–éƒ¨è¨­å‚™'
}

function getDeviceTypeName(type) {
  return deviceTypeNameMap[type] || type
}

function isProtectedType(type) {
  return protectedTypes.includes(type)
}

function openCreateDeviceTypeDialog() {
  isEditingDeviceType.value = false
  deviceTypeFormData.value = {
    type_key: '',
    display_name: '',
    icon: 'ğŸ“¦',
    description: '',
    characteristics: []
  }
  deviceTypeDialogVisible.value = true
}

function openEditDeviceTypeDialog(typeName) {
  isEditingDeviceType.value = true
  const typeData = deviceTypes.value[typeName]
  deviceTypeFormData.value = {
    type_key: typeName,
    display_name: typeData.display_name || getDeviceTypeName(typeName),
    icon: typeData.icon || 'ğŸ“¦',
    description: typeData.description || '',
    characteristics: [...(typeData.characteristics || [])]
  }
  deviceTypeDialogVisible.value = true
}

function addDeviceTypeCharacteristic() {
  if (newDeviceTypeCharacteristic.value.trim()) {
    deviceTypeFormData.value.characteristics.push(newDeviceTypeCharacteristic.value.trim())
    newDeviceTypeCharacteristic.value = ''
  }
}

function toggleCharacteristic(item, checked) {
  if (!deviceTypeFormData.value) return

  if (checked) {
    if (!deviceTypeFormData.value.characteristics.includes(item)) {
      deviceTypeFormData.value.characteristics.push(item)
    }
  } else {
    const index = deviceTypeFormData.value.characteristics.indexOf(item)
    if (index > -1) {
      deviceTypeFormData.value.characteristics.splice(index, 1)
    }
  }
}

async function saveDeviceTypeChanges() {
  if (!deviceTypeFormData.value.type_key || !deviceTypeFormData.value.display_name) {
    ElMessage.warning('è«‹å¡«å¯«é¡åˆ¥ Key å’Œé¡¯ç¤ºåç¨±')
    return
  }

  try {
    if (isEditingDeviceType.value) {
      // ç·¨è¼¯ç¾æœ‰è¨­å‚™é¡å‹
      const response = await axios.put(`/api/device-mapping/${deviceTypeFormData.value.type_key}`, {
        display_name: deviceTypeFormData.value.display_name,
        description: deviceTypeFormData.value.description,
        characteristics: deviceTypeFormData.value.characteristics,
        icon: deviceTypeFormData.value.icon
      })

      if (response.data.status === 'success') {
        ElMessage.success('è¨­å‚™é¡åˆ¥å·²æ›´æ–°')
        deviceTypeDialogVisible.value = false
        await fetchDeviceMapping()
      } else {
        ElMessage.error(response.data.error)
      }
    } else {
      // æ–°å¢è¨­å‚™é¡å‹
      const response = await axios.post('/api/device-mapping/types', {
        type_key: deviceTypeFormData.value.type_key,
        display_name: deviceTypeFormData.value.display_name,
        icon: deviceTypeFormData.value.icon,
        description: deviceTypeFormData.value.description,
        characteristics: deviceTypeFormData.value.characteristics
      })

      if (response.data.status === 'success') {
        ElMessage.success({
          message: response.data.message + ' - è«‹è¨˜å¾—é‡æ–°è¨“ç·´æ¨¡å‹ä»¥å¥—ç”¨è®Šæ›´',
          duration: 5000
        })
        deviceTypeDialogVisible.value = false
        await fetchDeviceMapping()
      } else {
        ElMessage.error(response.data.error)
      }
    }
  } catch (error) {
    ElMessage.error('æ“ä½œå¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
  }
}

async function handleDeleteDeviceType(typeName) {
  const typeData = deviceTypes.value[typeName]
  const ipCount = typeData.ip_ranges ? typeData.ip_ranges.length : 0

  try {
    await ElMessageBox.confirm(
      ipCount > 0
        ? `ç¢ºå®šè¦åˆªé™¤è¨­å‚™é¡åˆ¥ã€Œ${typeData.display_name || typeName}ã€å—ï¼Ÿ\næ­¤é¡åˆ¥é‚„æœ‰ ${ipCount} å€‹ IP ç¶²æ®µã€‚`
        : `ç¢ºå®šè¦åˆªé™¤è¨­å‚™é¡åˆ¥ã€Œ${typeData.display_name || typeName}ã€å—ï¼Ÿ`,
      'ç¢ºèªåˆªé™¤',
      {
        confirmButtonText: 'ç¢ºå®šåˆªé™¤',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning',
        dangerouslyUseHTMLString: true
      }
    )

    const response = await axios.delete(`/api/device-mapping/types/${typeName}`, {
      data: { force: ipCount > 0 }
    })

    if (response.data.status === 'success') {
      ElMessage.success({
        message: response.data.message + ' - è«‹è¨˜å¾—é‡æ–°è¨“ç·´æ¨¡å‹ä»¥å¥—ç”¨è®Šæ›´',
        duration: 5000
      })
      await fetchDeviceMapping()
    } else {
      ElMessage.error(response.data.error)
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('åˆªé™¤å¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
    }
  }
}

async function fetchDeviceMapping() {
  deviceMappingLoading.value = true
  try {
    const response = await axios.get('/api/device-mapping')
    if (response.data.status === 'success') {
      deviceTypes.value = response.data.data.device_types
    } else {
      ElMessage.error(response.data.error || 'è¼‰å…¥ç¶²æ®µè¨­å‚™é…ç½®å¤±æ•—')
    }
  } catch (error) {
    ElMessage.error('è¼‰å…¥ç¶²æ®µè¨­å‚™é…ç½®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message)
  } finally {
    deviceMappingLoading.value = false
  }
}

async function refreshDeviceMapping() {
  await fetchDeviceMapping()
  ElMessage.success('ç¶²æ®µè¨­å‚™é…ç½®å·²é‡æ–°è¼‰å…¥')
}

async function handleAddIpRange(typeName) {
  const ipRange = newIpRanges.value[typeName]
  if (!ipRange) {
    ElMessage.warning('è«‹è¼¸å…¥ IP ç¶²æ®µ')
    return
  }

  try {
    const response = await axios.post(`/api/device-mapping/${typeName}/ip-ranges`, {
      ip_range: ipRange
    })
    if (response.data.status === 'success') {
      ElMessage.success(response.data.message)
      newIpRanges.value[typeName] = ''
      await fetchDeviceMapping()
    } else {
      ElMessage.error(response.data.error)
    }
  } catch (error) {
    ElMessage.error('æ–°å¢å¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
  }
}

async function handleRemoveIpRange(typeName, ipRange) {
  try {
    await ElMessageBox.confirm(
      `ç¢ºå®šè¦ç§»é™¤ IP ç¶²æ®µ ${ipRange} å—ï¼Ÿ`,
      'ç¢ºèª',
      {
        confirmButtonText: 'ç¢ºå®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    )

    const response = await axios.delete(`/api/device-mapping/${typeName}/ip-ranges`, {
      data: { ip_range: ipRange }
    })

    if (response.data.status === 'success') {
      ElMessage.success(response.data.message)
      await fetchDeviceMapping()
    } else {
      ElMessage.error(response.data.error)
    }
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('ç§»é™¤å¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
    }
  }
}

function openEditDeviceDialog(typeName) {
  currentEditDeviceType.value = typeName
  editDeviceFormData.value = {
    icon: deviceTypes.value[typeName].icon || 'ğŸ“¦',
    description: deviceTypes.value[typeName].description,
    characteristics: [...(deviceTypes.value[typeName].characteristics || [])]
  }
  editDeviceDialogVisible.value = true
}

function addDeviceCharacteristic() {
  if (newDeviceCharacteristic.value.trim()) {
    editDeviceFormData.value.characteristics.push(newDeviceCharacteristic.value.trim())
    newDeviceCharacteristic.value = ''
  }
}

function removeDeviceCharacteristic(idx) {
  editDeviceFormData.value.characteristics.splice(idx, 1)
}

function toggleEditCharacteristic(item, checked) {
  if (!editDeviceFormData.value) return

  if (checked) {
    if (!editDeviceFormData.value.characteristics.includes(item)) {
      editDeviceFormData.value.characteristics.push(item)
    }
  } else {
    const index = editDeviceFormData.value.characteristics.indexOf(item)
    if (index > -1) {
      editDeviceFormData.value.characteristics.splice(index, 1)
    }
  }
}

async function saveDeviceType() {
  try {
    const response = await axios.put(`/api/device-mapping/${currentEditDeviceType.value}`, {
      description: editDeviceFormData.value.description,
      characteristics: editDeviceFormData.value.characteristics,
      icon: editDeviceFormData.value.icon
    })

    if (response.data.status === 'success') {
      ElMessage.success('å­˜æª”æˆåŠŸ')
      editDeviceDialogVisible.value = false
      await fetchDeviceMapping()
    } else {
      ElMessage.error(response.data.error)
    }
  } catch (error) {
    ElMessage.error('å­˜æª”å¤±æ•—ï¼š' + (error.response?.data?.error || error.message))
  }
}

onMounted(async () => {
  await trainingStore.fetchConfig()
  // å¾é…ç½®ä¸­è¼‰å…¥ç•¶å‰çš„åƒæ•¸å€¼
  if (trainingStore.config?.training_config?.n_estimators) {
    nEstimators.value = trainingStore.config.training_config.n_estimators
  }
  if (trainingStore.config?.training_config?.contamination) {
    contamination.value = trainingStore.config.training_config.contamination
  }
  if (trainingStore.config?.training_config?.anomaly_threshold) {
    anomalyThreshold.value = trainingStore.config.training_config.anomaly_threshold
  }

  // è¼‰å…¥è¨­å‚™æ˜ å°„é…ç½®
  await fetchDeviceMapping()
})

async function handleStartTraining() {
  await trainingStore.startTraining({
    days: trainingDays.value,
    n_estimators: nEstimators.value,
    contamination: contamination.value,
    exclude_servers: excludeServers.value,
    anomaly_threshold: anomalyThreshold.value
  })
}

function resetToDefaults() {
  trainingDays.value = DEFAULT_VALUES.trainingDays
  nEstimators.value = DEFAULT_VALUES.nEstimators
  contamination.value = DEFAULT_VALUES.contamination
  anomalyThreshold.value = DEFAULT_VALUES.anomalyThreshold
  excludeServers.value = DEFAULT_VALUES.excludeServers

  ElMessage.success({
    message: 'å·²æ¢å¾©ç‚ºé è¨­å€¼ï¼šè¨“ç·´å¤©æ•¸ 3 å¤©ã€æ±ºç­–æ¨¹ 150 æ£µã€æ±¡æŸ“ç‡ 0.05ã€ç•°å¸¸é–¾å€¼ 0.6',
    duration: 2000
  })
}

function getModelStatusText(status) {
  const statusMap = {
    'trained': 'å·²è¨“ç·´',
    'not_trained': 'å°šæœªè¨“ç·´',
    'training': 'è¨“ç·´ä¸­',
    'file_exists_but_load_failed': 'æ¨¡å‹æª”æ¡ˆæå£'
  }
  return statusMap[status] || status || 'æœªçŸ¥'
}

function getStatusTagType(status) {
  if (status === 'trained') return 'success'
  if (status === 'file_exists_but_load_failed') return 'danger'
  if (status === 'training') return 'info'
  return 'warning'
}

function formatTrainedDate(isoString) {
  if (!isoString) return 'N/A'
  const date = new Date(isoString)
  return date.toLocaleString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: false
  })
}
</script>

<style scoped>
.training {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
  max-width: 100%;
}

.model-info {
  padding: 10px 0;
}

.progress-card {
  margin-top: 20px;
  width: 100%;
}

.progress-content {
  padding: 20px;
}

.progress-message {
  margin-top: 12px;
  text-align: center;
  color: #606266;
}

.features-card {
  margin-top: 20px;
  width: 100%;
}

.features-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
  gap: 12px;
  padding: 10px 0;
}

.feature-tag {
  padding: 8px 12px;
  font-size: 13px;
  cursor: default;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 600;
}

.form-item-tip {
  margin-top: 8px;
  font-size: 12px;
  color: #909399;
  line-height: 1.5;
}

.device-mapping-card {
  margin-top: 20px;
  width: 100%;
}

.device-types-compact {
  padding: 10px 0;
}

.device-type-title {
  display: flex;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.type-icon {
  font-size: 18px;
}

.device-type-content {
  padding: 16px;
  background-color: #f5f7fa;
  border-radius: 4px;
}

.description {
  color: #606266;
  font-size: 14px;
}

.ip-ranges-section,
.characteristics-section {
  margin-top: 12px;
}

.range-list {
  display: flex;
  flex-wrap: wrap;
  margin-top: 8px;
}

.add-range-section {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 8px;
}

.icon-picker {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  max-width: 400px;
}

.icon-picker .el-button {
  min-width: 32px;
  padding: 4px 8px;
  font-size: 18px;
}

.characteristics-selector {
  padding: 12px;
  background-color: #f5f7fa;
  border-radius: 4px;
  margin-top: 8px;
  margin-bottom: 12px;
}

.characteristic-category {
  margin-bottom: 16px;
}

.characteristic-category:last-child {
  margin-bottom: 0;
}

.category-title {
  font-size: 13px;
  font-weight: 600;
  color: #303133;
  margin-bottom: 8px;
  padding-bottom: 4px;
  border-bottom: 1px solid #dcdfe6;
}

.characteristic-options {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}

.characteristic-options .el-checkbox {
  margin-right: 0;
}

.selected-characteristics {
  margin-bottom: 12px;
}

.selected-characteristics .el-tag {
  margin-right: 8px;
  margin-bottom: 8px;
}
</style>
