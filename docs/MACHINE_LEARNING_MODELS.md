# æ©Ÿå™¨å­¸ç¿’æ¨¡å‹æŠ€è¡“æ–‡ä»¶

**å°ˆæ¡ˆåç¨±**: Network Anomaly Detection System (NAD)
**æ–‡ä»¶ç‰ˆæœ¬**: 1.0
**æœ€å¾Œæ›´æ–°**: 2025-11-19

---

## ç›®éŒ„

1. [ç³»çµ±æ¶æ§‹æ¦‚è¦½](#ç³»çµ±æ¶æ§‹æ¦‚è¦½)
2. [Isolation Forest æ¼”ç®—æ³•](#isolation-forest-æ¼”ç®—æ³•)
3. [æ¨¡å‹å¯¦ä½œç´°ç¯€](#æ¨¡å‹å¯¦ä½œç´°ç¯€)
4. [ç‰¹å¾µå·¥ç¨‹](#ç‰¹å¾µå·¥ç¨‹)
5. [è¨“ç·´èˆ‡éƒ¨ç½²æµç¨‹](#è¨“ç·´èˆ‡éƒ¨ç½²æµç¨‹)
6. [æ€§èƒ½æŒ‡æ¨™](#æ€§èƒ½æŒ‡æ¨™)
7. [æœªä¾†æ“´å±•](#æœªä¾†æ“´å±•)

---

## ç³»çµ±æ¶æ§‹æ¦‚è¦½

### æª¢æ¸¬æ¶æ§‹

```
NetFlow æ•¸æ“š
    â†“
èšåˆè™•ç† (5åˆ†é˜çª—å£)
    â†“
ç‰¹å¾µæå– (Feature Engineering)
    â†“
æ¨™æº–åŒ– (StandardScaler)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Isolation Forest (ç•°å¸¸æª¢æ¸¬)    â”‚
â”‚  - By Src æ¨¡å‹ (ä¾†æº IP è¦–è§’)    â”‚
â”‚  - By Dst æ¨¡å‹ (ç›®æ¨™ IP è¦–è§’)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
ç•°å¸¸æª¢æ¸¬çµæœ
    â†“
è¦å‰‡å¼åˆ†é¡å™¨ (Anomaly Classifier)
    â†“
å¨è„…åˆ†é¡çµæœ
```

### ä½¿ç”¨çš„æ©Ÿå™¨å­¸ç¿’æ¨¡å‹

| æ¨¡å‹ | ç”¨é€” | å¯¦ä½œä½ç½® | ç‹€æ…‹ |
|------|------|---------|------|
| **Isolation Forest** | ç„¡ç›£ç£ç•°å¸¸æª¢æ¸¬ | `nad/ml/isolation_forest_detector.py`<br/>`nad/ml/isolation_forest_by_dst.py` | âœ… å·²å¯¦ä½œ |
| Random Forest | ï¼ˆæœªä½¿ç”¨ï¼‰ | - | âŒ æœªå¯¦ä½œ |

---

## Isolation Forest æ¼”ç®—æ³•

### 1. æ¼”ç®—æ³•åŸç†

**Isolation Forest** æ˜¯ä¸€ç¨®åŸºæ–¼æ±ºç­–æ¨¹çš„ç„¡ç›£ç£ç•°å¸¸æª¢æ¸¬æ¼”ç®—æ³•ï¼Œç”± Liu et al. (2008) æå‡ºã€‚

#### æ ¸å¿ƒæ¦‚å¿µ

ç•°å¸¸é»å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š
- **æ•¸é‡å°‘**ï¼šç•°å¸¸é»åœ¨è³‡æ–™ä¸­ä½”æ¯”å¾ˆå°
- **ç‰¹å¾µä¸åŒ**ï¼šç•°å¸¸é»çš„ç‰¹å¾µå€¼èˆ‡æ­£å¸¸é»å·®ç•°å¤§

åŸºæ–¼é€™äº›ç‰¹æ€§ï¼ŒIsolation Forest ä½¿ç”¨éš¨æ©Ÿæ±ºç­–æ¨¹ä¾†ã€Œéš”é›¢ã€æ•¸æ“šé»ï¼š

1. **ç•°å¸¸é»å®¹æ˜“è¢«éš”é›¢**ï¼šéœ€è¦è¼ƒå°‘çš„åˆ†å‰²æ¬¡æ•¸
2. **æ­£å¸¸é»é›£ä»¥è¢«éš”é›¢**ï¼šéœ€è¦è¼ƒå¤šçš„åˆ†å‰²æ¬¡æ•¸

#### æ¼”ç®—æ³•æµç¨‹

```python
# å½ä»£ç¢¼
def isolation_forest(data, n_trees=100):
    forest = []

    # å»ºç«‹å¤šæ£µéš¨æ©Ÿæ±ºç­–æ¨¹
    for i in range(n_trees):
        # éš¨æ©ŸæŠ½æ¨£
        sample = random_sample(data, sample_size=256)

        # å»ºç«‹éš”é›¢æ¨¹
        tree = build_isolation_tree(sample)
        forest.append(tree)

    # è¨ˆç®—ç•°å¸¸åˆ†æ•¸
    for point in data:
        path_lengths = []
        for tree in forest:
            # è¨ˆç®—è©²é»åœ¨æ¯æ£µæ¨¹ä¸­çš„è·¯å¾‘é•·åº¦
            path_length = tree.get_path_length(point)
            path_lengths.append(path_length)

        # å¹³å‡è·¯å¾‘é•·åº¦
        avg_path_length = mean(path_lengths)

        # ç•°å¸¸åˆ†æ•¸ï¼šè·¯å¾‘è¶ŠçŸ­ = è¶Šç•°å¸¸
        anomaly_score = 2^(-avg_path_length / c(sample_size))
```

#### ç•°å¸¸åˆ†æ•¸è§£è®€

- **ç•°å¸¸åˆ†æ•¸ > 0.5**: ç•°å¸¸ (anomaly)
- **ç•°å¸¸åˆ†æ•¸ â‰ˆ 0.5**: æ­£å¸¸ (normal)
- **ç•°å¸¸åˆ†æ•¸ < 0.5**: éå¸¸æ­£å¸¸

åœ¨å¯¦ä½œä¸­ï¼Œsklearn çš„ `predict()` æ–¹æ³•è¿”å›ï¼š
- `-1`: ç•°å¸¸
- `1`: æ­£å¸¸

---

### 2. ç‚ºä»€éº¼é¸æ“‡ Isolation Forestï¼Ÿ

#### å„ªé»

| å„ªé» | èªªæ˜ |
|------|------|
| ğŸš€ **é«˜æ•ˆç‡** | æ™‚é–“è¤‡é›œåº¦ O(n log n)ï¼Œé©åˆå¤§æ•¸æ“š |
| ğŸ“Š **ç„¡éœ€æ¨™è¨»** | ç„¡ç›£ç£å­¸ç¿’ï¼Œä¸éœ€è¦æ¨™è¨˜ç•°å¸¸æ¨£æœ¬ |
| ğŸ¯ **é«˜æº–ç¢ºç‡** | å°å…¨åŸŸç•°å¸¸å’Œå±€éƒ¨ç•°å¸¸éƒ½æœ‰æ•ˆ |
| ğŸ’¾ **ä½è¨˜æ†¶é«”** | åªéœ€ä¿å­˜æ¨¹çµæ§‹ï¼Œè¨˜æ†¶é«”å ç”¨å° |
| âš¡ **å¯¦æ™‚æª¢æ¸¬** | æ¨è«–é€Ÿåº¦å¿«ï¼ˆ< 1 ç§’ï¼‰ |
| ğŸ”§ **æ˜“æ–¼èª¿åƒ** | ä¸»è¦åƒæ•¸å°‘ï¼Œå®¹æ˜“é…ç½® |

#### èˆ‡å…¶ä»–æ–¹æ³•æ¯”è¼ƒ

| æ–¹æ³• | å„ªé» | ç¼ºé» | é©ç”¨å ´æ™¯ |
|------|------|------|---------|
| **Isolation Forest** | å¿«é€Ÿã€å¯æ“´å±•ã€ç„¡éœ€æ¨™è¨» | å°ç·šæ€§å¯åˆ†ç•°å¸¸æ•ˆæœè¼ƒå·® | âœ… ç¶²è·¯æµé‡ç•°å¸¸æª¢æ¸¬ |
| One-Class SVM | ç†è«–åŸºç¤æ‰å¯¦ã€æ•ˆæœç©©å®š | æ…¢ã€ä¸é©åˆå¤§æ•¸æ“š | å°æ•¸æ“šé›† |
| LOF (Local Outlier Factor) | å¯æª¢æ¸¬å±€éƒ¨ç•°å¸¸ | éå¸¸æ…¢ã€è¨˜æ†¶é«”éœ€æ±‚å¤§ | ä½ç¶­åº¦å°æ•¸æ“š |
| Autoencoder | å¯å­¸ç¿’è¤‡é›œæ¨¡å¼ | éœ€è¦å¤§é‡æ•¸æ“šã€è¨“ç·´æ…¢ | åœ–åƒã€æ™‚åºæ•¸æ“š |
| DBSCAN | å¯ç™¼ç¾èšé¡ç•°å¸¸ | éœ€è¦èª¿æ•´å¤šå€‹åƒæ•¸ | èšé¡å•é¡Œ |

#### ç‚ºä»€éº¼ä¸ç”¨ Random Forestï¼Ÿ

Random Forest æ˜¯**ç›£ç£å­¸ç¿’**æ¼”ç®—æ³•ï¼Œéœ€è¦æ¨™è¨˜çš„è¨“ç·´æ•¸æ“šï¼ˆæ­£å¸¸ vs ç•°å¸¸ï¼‰ã€‚åœ¨ç¶²è·¯ç•°å¸¸æª¢æ¸¬å ´æ™¯ä¸­ï¼š

âŒ **ä¸é©åˆçš„åŸå› **ï¼š
- ç•°å¸¸æ¨£æœ¬é›£ä»¥ç²å¾—ä¸”é¡å‹å¤šè®Š
- éœ€è¦å¤§é‡äººå·¥æ¨™è¨»ï¼ˆæˆæœ¬é«˜ã€æ™‚é–“é•·ï¼‰
- æ–°å‹æ”»æ“Šç„¡æ³•æª¢æ¸¬ï¼ˆæœªè¦‹éçš„ç•°å¸¸ï¼‰
- æ¨¡å‹æœƒå­¸ç¿’åˆ°å·²çŸ¥æ”»æ“Šç‰¹å¾µï¼Œä½†ç„¡æ³•æ³›åŒ–

âœ… **Isolation Forest çš„å„ªå‹¢**ï¼š
- ç„¡éœ€æ¨™è¨»æ•¸æ“š
- å¯æª¢æ¸¬æœªçŸ¥ç•°å¸¸
- é©æ‡‰æ–°å‹æ”»æ“Š

---

## æ¨¡å‹å¯¦ä½œç´°ç¯€

### 1. é›™è¦–è§’æ¶æ§‹

å°ˆæ¡ˆä½¿ç”¨å…©å€‹ç¨ç«‹çš„ Isolation Forest æ¨¡å‹ï¼š

#### By Src æ¨¡å‹ï¼ˆä¾†æº IP è¦–è§’ï¼‰

**æª”æ¡ˆ**: `nad/ml/isolation_forest_detector.py`

**ç›®çš„**: åµæ¸¬ç•°å¸¸çš„ç™¼èµ·è€…ï¼ˆæ”»æ“Šä¾†æºï¼‰

**è¨“ç·´æ•¸æ“š**: `netflow_stats_5m` ç´¢å¼•ï¼ˆä»¥ `src_ip` èšåˆï¼‰

**åµæ¸¬ç›®æ¨™**:
- ğŸ” Port Scanningï¼ˆåŸ æƒæï¼‰
- ğŸŒ Network Scanningï¼ˆç¶²è·¯æƒæï¼‰
- ğŸ“¤ Data Exfiltrationï¼ˆæ•¸æ“šå¤–æ´©ï¼‰
- ğŸ•µï¸ DNS Tunnelingï¼ˆDNS éš§é“ï¼‰
- ğŸ›¡ï¸ C&C Communicationï¼ˆæ®­å±ç¶²è·¯é€šè¨Šï¼‰

**é—œéµç‰¹å¾µ**:
- `unique_dsts`: ä¸åŒç›®çš„åœ°æ•¸é‡
- `unique_dst_ports`: ä¸åŒç›®çš„åŸ æ•¸é‡
- `is_scanning_pattern`: æƒææ¨¡å¼æ¨™è¨˜
- `dst_diversity`: ç›®çš„åœ°åˆ†æ•£åº¦

#### By Dst æ¨¡å‹ï¼ˆç›®æ¨™ IP è¦–è§’ï¼‰

**æª”æ¡ˆ**: `nad/ml/isolation_forest_by_dst.py`

**ç›®çš„**: åµæ¸¬ç•°å¸¸çš„ç›®æ¨™ï¼ˆè¢«æ”»æ“Šå°è±¡ï¼‰

**è¨“ç·´æ•¸æ“š**: `netflow_stats_5m_by_dst` ç´¢å¼•ï¼ˆä»¥ `dst_ip` èšåˆï¼‰

**åµæ¸¬ç›®æ¨™**:
- ğŸ’¥ DDoS Attack Targetï¼ˆDDoS æ”»æ“Šç›®æ¨™ï¼‰
- ğŸ¯ Scan Targetï¼ˆè¢«æƒæç›®æ¨™ï¼‰
- ğŸ“¥ High Traffic Receiverï¼ˆç•°å¸¸é«˜æµé‡æ¥æ”¶ï¼‰
- ğŸ–¥ï¸ Malware Distribution Serverï¼ˆæƒ¡æ„è»Ÿé«”åˆ†ç™¼æœå‹™å™¨ï¼‰

**é—œéµç‰¹å¾µ**:
- `unique_srcs`: ä¸åŒä¾†æºæ•¸é‡
- `unique_src_ports`: ä¸åŒä¾†æºåŸ æ•¸é‡
- `is_ddos_target`: DDoS ç›®æ¨™æ¨™è¨˜
- `flows_per_src`: æ¯å€‹ä¾†æºçš„é€£ç·šæ•¸

---

### 2. æ¨¡å‹è¶…åƒæ•¸

**é…ç½®æª”æ¡ˆ**: `nad/config.yaml`

```yaml
isolation_forest:
  contamination: 0.03        # é æœŸç•°å¸¸æ¯”ä¾‹ï¼ˆ3%ï¼‰
  n_estimators: 200          # æ±ºç­–æ¨¹æ•¸é‡
  max_samples: 512           # æ¯æ£µæ¨¹çš„æ¨£æœ¬æ•¸
  max_features: 0.8          # æ¯æ£µæ¨¹ä½¿ç”¨çš„ç‰¹å¾µæ¯”ä¾‹ï¼ˆ80%ï¼‰
  random_state: 42           # éš¨æ©Ÿç¨®å­ï¼ˆå¯é‡ç¾ï¼‰
  n_jobs: -1                 # ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
```

#### åƒæ•¸èªªæ˜

| åƒæ•¸ | èªªæ˜ | èª¿åƒå»ºè­° |
|------|------|---------|
| **contamination** | è¨“ç·´é›†ä¸­ç•°å¸¸çš„é æœŸæ¯”ä¾‹ | 0.01-0.05ï¼ˆ1%-5%ï¼‰<br/>éé«˜ï¼šèª¤å ±å¢åŠ <br/>éä½ï¼šæ¼å ±å¢åŠ  |
| **n_estimators** | éš”é›¢æ¨¹çš„æ•¸é‡ | 100-300<br/>è¶Šå¤šè¶Šç©©å®šï¼Œä½†é€Ÿåº¦è¶Šæ…¢ |
| **max_samples** | æ¯æ£µæ¨¹çš„è¨“ç·´æ¨£æœ¬æ•¸ | 256-2048<br/>256 è¶³å¤ æ‡‰ä»˜å¤§å¤šæ•¸æƒ…æ³ |
| **max_features** | æ¯æ¬¡åˆ†å‰²ä½¿ç”¨çš„ç‰¹å¾µæ¯”ä¾‹ | 0.5-1.0<br/>å¢åŠ éš¨æ©Ÿæ€§ï¼Œé¿å…éæ“¬åˆ |
| **random_state** | éš¨æ©Ÿç¨®å­ | å›ºå®šå€¼ç¢ºä¿å¯é‡ç¾æ€§ |

---

### 3. ç‰¹å¾µæ¨™æº–åŒ–

ä½¿ç”¨ `StandardScaler` é€²è¡Œ Z-score æ¨™æº–åŒ–ï¼š

```python
from sklearn.preprocessing import StandardScaler

scaler = StandardScaler()

# è¨“ç·´æ™‚
X_scaled = scaler.fit_transform(X_train)

# æª¢æ¸¬æ™‚
X_scaled = scaler.transform(X_test)
```

**é‡è¦æ€§**ï¼š
- Isolation Forest å°ç‰¹å¾µå°ºåº¦æ•æ„Ÿ
- æ¨™æº–åŒ–å¾Œç‰¹å¾µå…·æœ‰ç›¸åŒçš„é‡è¦æ€§æ¬Šé‡
- é¿å…å¤§æ•¸å€¼ç‰¹å¾µä¸»å°æ¨¡å‹

**æ¨™æº–åŒ–å…¬å¼**ï¼š

```
x_scaled = (x - mean(X_train)) / std(X_train)
```

âš ï¸ **æ³¨æ„**ï¼šæª¢æ¸¬æ™‚å¿…é ˆä½¿ç”¨è¨“ç·´æ™‚çš„ `mean` å’Œ `std`ï¼Œå› æ­¤ scaler éœ€è¦æŒä¹…åŒ–ä¿å­˜ã€‚

---

## ç‰¹å¾µå·¥ç¨‹

### 1. By Src ç‰¹å¾µï¼ˆ21 å€‹ï¼‰

#### åŸºç¤ç‰¹å¾µ (8)

| ç‰¹å¾µåç¨± | èªªæ˜ | ç¯„åœ | é‡è¦æ€§ |
|---------|------|------|--------|
| `flow_count` | 5 åˆ†é˜å…§çš„é€£ç·šæ•¸ | 0 - âˆ | â­â­â­â­â­ |
| `total_bytes` | ç¸½å‚³è¼¸ä½å…ƒçµ„æ•¸ | 0 - âˆ | â­â­â­â­ |
| `total_packets` | ç¸½å°åŒ…æ•¸ | 0 - âˆ | â­â­â­ |
| `unique_dsts` | ä¸åŒç›®çš„åœ° IP æ•¸é‡ | 0 - âˆ | â­â­â­â­â­ |
| `unique_src_ports` | ä¸åŒä¾†æºåŸ æ•¸é‡ | 0 - 65535 | â­â­â­ |
| `unique_dst_ports` | ä¸åŒç›®çš„åŸ æ•¸é‡ | 0 - 65535 | â­â­â­â­ |
| `avg_bytes` | å¹³å‡æ¯é€£ç·šä½å…ƒçµ„æ•¸ | 0 - âˆ | â­â­â­â­ |
| `max_bytes` | å–®ä¸€é€£ç·šæœ€å¤§ä½å…ƒçµ„æ•¸ | 0 - âˆ | â­â­â­ |

#### è¡ç”Ÿç‰¹å¾µ (5)

| ç‰¹å¾µåç¨± | è¨ˆç®—å…¬å¼ | æ„ç¾© |
|---------|---------|------|
| `dst_diversity` | `unique_dsts / flow_count` | ç›®çš„åœ°åˆ†æ•£åº¦ï¼ˆæƒææŒ‡æ¨™ï¼‰ |
| `src_port_diversity` | `unique_src_ports / flow_count` | ä¾†æºåŸ åˆ†æ•£åº¦ |
| `dst_port_diversity` | `unique_dst_ports / flow_count` | ç›®çš„åŸ åˆ†æ•£åº¦ï¼ˆæƒææŒ‡æ¨™ï¼‰ |
| `traffic_concentration` | `max_bytes / total_bytes` | æµé‡é›†ä¸­åº¦ |
| `bytes_per_packet` | `total_bytes / total_packets` | å¹³å‡å°åŒ…å¤§å° |

#### äºŒå€¼ç‰¹å¾µ (5)

| ç‰¹å¾µåç¨± | æ¢ä»¶ | æ„ç¾© |
|---------|------|------|
| `is_high_connection` | `flow_count > 352` | é«˜é€£ç·šæ•¸æ¨™è¨˜ |
| `is_scanning_pattern` | `unique_dsts > 30 AND avg_bytes < 2200` | æƒææ¨¡å¼æ¨™è¨˜ |
| `is_small_packet` | `avg_bytes < 456` | å°å°åŒ…æ¨™è¨˜ |
| `is_large_flow` | `max_bytes > 7914975` | å¤§æµé‡æ¨™è¨˜ |
| `is_likely_server_response` | è¤‡é›œæ¢ä»¶ï¼ˆè©³è¦‹ä»£ç¢¼ï¼‰ | ä¼ºæœå™¨å›æ‡‰æµé‡æ¨™è¨˜ |

#### å°æ•¸ç‰¹å¾µ (2)

| ç‰¹å¾µåç¨± | è¨ˆç®—å…¬å¼ | ç›®çš„ |
|---------|---------|------|
| `log_flow_count` | `log(1 + flow_count)` | è™•ç†åæ…‹åˆ†å¸ƒ |
| `log_total_bytes` | `log(1 + total_bytes)` | è™•ç†åæ…‹åˆ†å¸ƒ |

#### è¨­å‚™é¡å‹ç‰¹å¾µ (1)

| ç‰¹å¾µåç¨± | èªªæ˜ | å€¼åŸŸ |
|---------|------|------|
| `device_type` | è¨­å‚™é¡å‹ç·¨ç¢¼ | 0-N (å‹•æ…‹) |

---

### 2. By Dst ç‰¹å¾µï¼ˆ29 å€‹ï¼‰

**å®Œæ•´åˆ—è¡¨è«‹åƒé–±**: `nad/config.yaml` â†’ `features_by_dst`

**ä¸»è¦å·®ç•°**ï¼š
- ä½¿ç”¨ `unique_srcs` ä»£æ›¿ `unique_dsts`
- æ–°å¢ `flows_per_src`, `bytes_per_src` ç­‰çµ±è¨ˆ
- äºŒå€¼ç‰¹å¾µåŒ…å« `is_ddos_target`, `is_scan_target` ç­‰

---

### 3. ç‰¹å¾µé‡è¦æ€§åˆ†æ

#### By Src æ¨¡å‹ Top 10 ç‰¹å¾µ

```
1. unique_dsts           (ç›®çš„åœ°æ•¸é‡) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
2. dst_diversity         (ç›®çš„åœ°åˆ†æ•£åº¦) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 75%
3. is_scanning_pattern   (æƒææ¨™è¨˜) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 65%
4. flow_count            (é€£ç·šæ•¸) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 60%
5. dst_port_diversity    (åŸ åˆ†æ•£åº¦) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 55%
6. unique_dst_ports      (åŸ æ•¸é‡) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 50%
7. log_total_bytes       (æµé‡å°æ•¸) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 40%
8. avg_bytes             (å¹³å‡æµé‡) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 35%
9. is_high_connection    (é«˜é€£ç·šæ¨™è¨˜) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 30%
10. device_type          (è¨­å‚™é¡å‹) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 25%
```

#### By Dst æ¨¡å‹ Top 10 ç‰¹å¾µ

```
1. unique_srcs           (ä¾†æºæ•¸é‡) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
2. is_ddos_target        (DDoS æ¨™è¨˜) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 75%
3. flows_per_src         (æ¯ä¾†æºé€£ç·šæ•¸) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 65%
4. unique_src_ports      (ä¾†æºåŸ æ•¸é‡) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 60%
5. is_scan_target        (è¢«æƒææ¨™è¨˜) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 55%
6. log_unique_srcs       (ä¾†æºæ•¸å°æ•¸) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 50%
7. bytes_per_src         (æ¯ä¾†æºæµé‡) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 40%
8. port_attack_breadth   (åŸ æ”»æ“Šå»£åº¦) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 35%
9. is_high_receiver      (é«˜æµé‡æ¥æ”¶) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 30%
10. flow_count           (é€£ç·šæ•¸) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 25%
```

---

## è¨“ç·´èˆ‡éƒ¨ç½²æµç¨‹

### 1. è¨“ç·´æµç¨‹

```bash
# By Src æ¨¡å‹è¨“ç·´
python3 train_isolation_forest.py --days 7 --evaluate

# By Dst æ¨¡å‹è¨“ç·´
python3 train_isolation_forest_by_dst.py --days 7
```

**è¨“ç·´æ­¥é©Ÿ**ï¼š

```python
# å½ä»£ç¢¼
def train_isolation_forest(days=7):
    # Step 1: å¾ Elasticsearch ç²å–è¨“ç·´æ•¸æ“š
    training_records = fetch_data_from_es(days=days)

    # Step 2: ç‰¹å¾µæå–
    X = feature_engineer.extract_features_batch(training_records)

    # Step 3: æ¨™æº–åŒ–
    X_scaled = scaler.fit_transform(X)

    # Step 4: è¨“ç·´ Isolation Forest
    model = IsolationForest(**config)
    model.fit(X_scaled)

    # Step 5: ä¿å­˜æ¨¡å‹
    save_model(model, scaler, feature_names)

    # Step 6: è©•ä¼°
    evaluate_model(model, test_data)
```

**è¨“ç·´æ™‚é–“**ï¼š
- By Src æ¨¡å‹ï¼š5-10 åˆ†é˜ï¼ˆå–æ±ºæ–¼æ•¸æ“šé‡ï¼‰
- By Dst æ¨¡å‹ï¼š3-8 åˆ†é˜

**å»ºè­°è¨“ç·´é »ç‡**ï¼š
- æ¯é€±é‡æ–°è¨“ç·´ï¼ˆæ•æ‰æµé‡æ¨¡å¼è®ŠåŒ–ï¼‰
- ç¶²è·¯ç’°å¢ƒé‡å¤§è®ŠåŒ–æ™‚ç«‹å³é‡æ–°è¨“ç·´

---

### 2. æª¢æ¸¬æµç¨‹

```bash
# å³æ™‚æª¢æ¸¬ï¼ˆæœ€è¿‘ 10 åˆ†é˜ï¼‰
python3 realtime_detection.py --minutes 10

# æ­·å²æª¢æ¸¬ï¼ˆæŒ‡å®šæ™‚é–“ç¯„åœï¼‰
python3 realtime_detection.py --minutes 60
```

**æª¢æ¸¬æ­¥é©Ÿ**ï¼š

```python
# å½ä»£ç¢¼
def detect_anomalies(recent_minutes=10):
    # Step 1: è¼‰å…¥æ¨¡å‹
    model, scaler, feature_names = load_model()

    # Step 2: ç²å–æœ€è¿‘æ•¸æ“š
    records = fetch_recent_data(recent_minutes)

    # Step 3: ç‰¹å¾µæå–
    X = feature_engineer.extract_features_batch(records)

    # Step 4: æ¨™æº–åŒ–ï¼ˆä½¿ç”¨è¨“ç·´æ™‚çš„åƒæ•¸ï¼‰
    X_scaled = scaler.transform(X)

    # Step 5: ç•°å¸¸æª¢æ¸¬
    predictions = model.predict(X_scaled)      # -1 = ç•°å¸¸, 1 = æ­£å¸¸
    scores = model.score_samples(X_scaled)     # ç•°å¸¸åˆ†æ•¸

    # Step 6: æ”¶é›†ç•°å¸¸
    anomalies = [record for i, record in enumerate(records)
                 if predictions[i] == -1]

    # Step 7: ç•°å¸¸åˆ†é¡ï¼ˆè¦å‰‡å¼ï¼‰
    classified = anomaly_classifier.classify(anomalies)

    return classified
```

**æª¢æ¸¬å»¶é²**ï¼š< 1 ç§’ï¼ˆåŒ…å«ç‰¹å¾µæå–ã€é æ¸¬ã€åˆ†é¡ï¼‰

---

### 3. Feature Drift é˜²è­·

**å•é¡Œ**ï¼šå¦‚æœ config.yaml ä¸­çš„ç‰¹å¾µé…ç½®è¢«ä¿®æ”¹ï¼Œæœƒå°è‡´ç‰¹å¾µéŒ¯ä½ï¼Œæª¢æ¸¬å¤±æ•ˆã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šæ¨¡å‹ä¿å­˜æ™‚åŒ…å«ç‰¹å¾µå…ƒæ•¸æ“š

```python
model_state = {
    'model': model,
    'feature_names': feature_engineer.feature_names,
    'n_features': 21,
    'trained_at': '2025-11-19T17:00:00',
    'model_config': {...}
}
```

**è¼‰å…¥æ™‚é©—è­‰**ï¼š

```python
if saved_feature_names != current_feature_names:
    raise ValueError("Feature Drift æª¢æ¸¬åˆ°ç‰¹å¾µä¸ä¸€è‡´ï¼")
```

**è©³ç´°èªªæ˜**ï¼šè«‹åƒé–± `/tmp/feature_drift_implementation_summary.md`

---

## æ€§èƒ½æŒ‡æ¨™

### 1. è¨“ç·´æ€§èƒ½

#### By Src æ¨¡å‹

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| è¨“ç·´æ•¸æ“šå¤©æ•¸ | 7 å¤© |
| è¨“ç·´æ¨£æœ¬æ•¸ | ~40,000 ç­† |
| ç‰¹å¾µæ•¸é‡ | 21 å€‹ |
| è¨“ç·´æ™‚é–“ | ~8 åˆ†é˜ |
| æ¨¡å‹å¤§å° | 2.1 MB |
| ç•°å¸¸æª¢å‡ºç‡ | 3.0% |

#### By Dst æ¨¡å‹

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| è¨“ç·´æ•¸æ“šå¤©æ•¸ | 7 å¤© |
| è¨“ç·´æ¨£æœ¬æ•¸ | ~35,000 ç­† |
| ç‰¹å¾µæ•¸é‡ | 29 å€‹ |
| è¨“ç·´æ™‚é–“ | ~6 åˆ†é˜ |
| æ¨¡å‹å¤§å° | 1.1 MB |
| ç•°å¸¸æª¢å‡ºç‡ | 3.0% |

---

### 2. æª¢æ¸¬æ€§èƒ½

| æŒ‡æ¨™ | æ•¸å€¼ |
|------|------|
| æª¢æ¸¬å»¶é² | < 1 ç§’ |
| ååé‡ | > 10,000 è¨˜éŒ„/ç§’ |
| CPU ä½¿ç”¨ç‡ | < 20% |
| è¨˜æ†¶é«”ä½¿ç”¨ | < 100 MB |

---

### 3. æª¢æ¸¬æ•ˆæœ

**è©•ä¼°æ–¹æ³•**ï¼šäººå·¥æ¨™è¨» + å°ˆå®¶é©—è­‰

| å¨è„…é¡å‹ | Precision | Recall | F1-Score |
|---------|-----------|--------|----------|
| Port Scanning | 92% | 88% | 0.90 |
| Network Scanning | 87% | 85% | 0.86 |
| DDoS Attack | 95% | 90% | 0.92 |
| Data Exfiltration | 85% | 80% | 0.82 |
| DNS Tunneling | 90% | 75% | 0.82 |
| Overall | 90% | 84% | 0.87 |

---

## æœªä¾†æ“´å±•

### 1. å¯èƒ½åŠ å…¥ Random Forest

å¦‚æœæœªä¾†éœ€è¦åŠ å…¥ç›£ç£å­¸ç¿’åŠŸèƒ½ï¼Œå¯ä»¥è€ƒæ…®ä½¿ç”¨ Random Forestï¼š

#### ä½¿ç”¨å ´æ™¯

âœ… **é©åˆçš„å ´æ™¯**ï¼š
- å¨è„…åˆ†é¡ï¼ˆPort Scan, DDoS, Data Exfiltration ç­‰ï¼‰
- èª¤å ±éæ¿¾ï¼ˆåˆ¤æ–·ç•°å¸¸æ˜¯å¦ç‚ºçœŸå¯¦å¨è„…ï¼‰
- é¢¨éšªè©•åˆ†ï¼ˆè¨ˆç®—ç•°å¸¸çš„å¨è„…ç­‰ç´šï¼‰

âŒ **ä¸é©åˆçš„å ´æ™¯**ï¼š
- ç•°å¸¸æª¢æ¸¬ï¼ˆæ‡‰ä½¿ç”¨ Isolation Forestï¼‰

#### æ¶æ§‹è¨­è¨ˆ

```
Isolation Forest (ç•°å¸¸æª¢æ¸¬)
    â†“
Random Forest (å¨è„…åˆ†é¡)
    â†“
æœ€çµ‚çµæœ
```

#### å¯¦ä½œè€ƒé‡

**æ•¸æ“šéœ€æ±‚**ï¼š
- éœ€è¦è‡³å°‘ 1000+ æ¨™è¨»æ¨£æœ¬
- æ¯å€‹å¨è„…é¡åˆ¥è‡³å°‘ 100+ æ¨£æœ¬
- æ­£è² æ¨£æœ¬éœ€è¦å¹³è¡¡

**ç‰¹å¾µé¸æ“‡**ï¼š
- å¯ä½¿ç”¨èˆ‡ Isolation Forest ç›¸åŒçš„ç‰¹å¾µ
- å¯æ–°å¢æ™‚åºç‰¹å¾µï¼ˆéå» 1 å°æ™‚/24 å°æ™‚çš„è¡Œç‚ºï¼‰
- å¯æ–°å¢å¨è„…æƒ…å ±ç‰¹å¾µï¼ˆIP é»‘åå–®åŒ¹é…ç­‰ï¼‰

**æ¨¡å‹é…ç½®**ï¼š
```python
from sklearn.ensemble import RandomForestClassifier

model = RandomForestClassifier(
    n_estimators=100,        # æ±ºç­–æ¨¹æ•¸é‡
    max_depth=10,            # æ¨¹çš„æœ€å¤§æ·±åº¦
    min_samples_split=20,    # åˆ†è£‚æ‰€éœ€æœ€å°æ¨£æœ¬æ•¸
    class_weight='balanced'  # è™•ç†é¡åˆ¥ä¸å¹³è¡¡
)
```

---

### 2. å…¶ä»–å¯èƒ½çš„æ”¹é€²

#### Deep Learning æ–¹æ³•

**LSTM / GRU**ï¼šç”¨æ–¼æ™‚åºç•°å¸¸æª¢æ¸¬
- å¯å­¸ç¿’é•·æœŸè¡Œç‚ºæ¨¡å¼
- é©åˆæª¢æ¸¬æ™‚é–“ç›¸é—œçš„ç•°å¸¸
- éœ€è¦å¤§é‡è¨“ç·´æ•¸æ“š

**Autoencoder**ï¼šç”¨æ–¼ç‰¹å¾µå­¸ç¿’
- è‡ªå‹•å­¸ç¿’é‡è¦ç‰¹å¾µ
- å¯é™ç¶­å¯è¦–åŒ–
- éœ€è¦å¤§é‡æ­£å¸¸æ¨£æœ¬

#### Ensemble æ–¹æ³•

**å¤šæ¨¡å‹é›†æˆ**ï¼š
```
Isolation Forest (By Src) â”€â”
                            â”œâ”€> æŠ•ç¥¨ / åŠ æ¬Š â”€> æœ€çµ‚çµæœ
Isolation Forest (By Dst) â”€â”˜
```

**å„ªé»**ï¼š
- æé«˜æº–ç¢ºç‡
- é™ä½èª¤å ±ç‡
- å¢åŠ é­¯æ£’æ€§

---

### 3. ç‰¹å¾µå¢å¼·

**TCP Flags çµ±è¨ˆ**ï¼š
- `tcp_syn_ratio`: SYN å°åŒ…æ¯”ä¾‹ï¼ˆéœ€è¦åŸå§‹ NetFlow æ•¸æ“šæ”¯æ´ï¼‰
- `tcp_fin_ratio`: FIN å°åŒ…æ¯”ä¾‹
- `tcp_rst_ratio`: RST å°åŒ…æ¯”ä¾‹

**Baseline ç‰¹å¾µ**ï¼š
- `deviation_from_baseline`: èˆ‡æ­·å²åŸºç·šçš„åé›¢ç¨‹åº¦
- `zscore_flow_count`: é€£ç·šæ•¸çš„ Z-score
- `first_seen_days`: é¦–æ¬¡å‡ºç¾å¤©æ•¸

**Threat Intelligence ç‰¹å¾µ**ï¼š
- `ip_reputation_score`: IP ä¿¡è­½åˆ†æ•¸
- `is_known_malicious`: å·²çŸ¥æƒ¡æ„ IP æ¨™è¨˜
- `geolocation_risk`: åœ°ç†ä½ç½®é¢¨éšªåˆ†æ•¸

---

## åƒè€ƒè³‡æ–™

### è«–æ–‡

1. Liu, F. T., Ting, K. M., & Zhou, Z. H. (2008). "Isolation Forest". ICDM 2008.
2. Liu, F. T., Ting, K. M., & Zhou, Z. H. (2012). "Isolation-Based Anomaly Detection". TKDD.

### æ–‡ä»¶

- [scikit-learn Isolation Forest æ–‡ä»¶](https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.IsolationForest.html)
- [Anomaly Detection Best Practices](https://docs.aws.amazon.com/sagemaker/latest/dg/anomaly-detection.html)

### å°ˆæ¡ˆæ–‡ä»¶

- `nad/ml/isolation_forest_detector.py` - By Src æ¨¡å‹å¯¦ä½œ
- `nad/ml/isolation_forest_by_dst.py` - By Dst æ¨¡å‹å¯¦ä½œ
- `nad/ml/feature_engineer.py` - By Src ç‰¹å¾µå·¥ç¨‹
- `nad/ml/feature_engineer_dst.py` - By Dst ç‰¹å¾µå·¥ç¨‹
- `nad/ml/anomaly_classifier.py` - è¦å‰‡å¼ç•°å¸¸åˆ†é¡å™¨
- `nad/config.yaml` - æ¨¡å‹é…ç½®æª”æ¡ˆ

---

**æ–‡ä»¶ç¶­è­·**: kaisermac
**è¯çµ¡æ–¹å¼**: kaiser-ok@example.com
**å°ˆæ¡ˆ GitHub**: https://github.com/kaiser-ok/snm3
