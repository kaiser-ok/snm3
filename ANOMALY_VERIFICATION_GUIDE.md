# 異常驗證與閾值調優指南

## 📋 概述

當 Isolation Forest 檢測出異常後，需要**驗證這些異常是否為真**，或是因為閾值設置不當導致的誤報。

本指南提供兩個工具：
1. **verify_anomaly.py** - 深入分析單個異常 IP
2. **tune_thresholds.py** - 批量分析並提供閾值調優建議

---

## 🔧 工具 1: verify_anomaly.py

### 功能

深入查詢原始 netflow 數據，從多個維度分析異常 IP：

- **目的地分析** - 檢測掃描、定向攻擊
- **通訊埠分析** - 檢測通訊埠掃描、連續掃描
- **協定分析** - ICMP/UDP/TCP 分布
- **時間分析** - 突發流量、週期性模式
- **流量分析** - 數據外洩、異常流量
- **行為分析** - 綜合判斷異常類型

### 使用方法

#### 1. 先運行檢測找出異常 IP

```bash
python3 realtime_detection.py --minutes 30
```

**輸出示例：**
```
⚠️  發現 5 個異常

===================================================================================================
排名   IP地址           異常分數     置信度      連線數      目的地    平均流量
===================================================================================================
1      192.168.10.135   0.6234      0.89       510,823    107       4,567
2      192.168.20.56    0.5891      0.82       394,143    8         342
3      192.168.15.42    0.5123      0.76       12,456     65        8,901
```

#### 2. 驗證單個異常 IP

```bash
# 分析最近 30 分鐘的數據
python3 verify_anomaly.py --ip 192.168.10.135 --minutes 30
```

**輸出報告：**

```
====================================================================================================
🔍 深入分析: 192.168.10.135
====================================================================================================

📊 找到 510,823 筆 netflow 記錄

📋 分析報告

📊 基本統計:
   • 總連線數: 510,823
   • 總流量: 2,334.56 MB
   • 平均每連線: 4,567 bytes

🎯 目的地分析:
   • 唯一目的地: 107
   • 目的地多樣性: 0.000209
   ⚠️  高度分散（疑似掃描）

   前 5 個目的地:
      192.168.1.1          → 8,234 次 (1.6%)
      192.168.1.2          → 7,891 次 (1.5%)
      ...

🔌 通訊埠分析:
   • 不同通訊埠: 89
   • 通訊埠分散度: 0.000174
   ⚠️  疑似通訊埠掃描
   ⚠️  檢測到連續通訊埠掃描

   前 5 個通訊埠:
        80 (HTTP          ) → 45,678 次 (8.9%)
       443 (HTTPS         ) → 34,567 次(6.8%)
        22 (SSH           ) → 23,456 次 (4.6%)
       ...

📡 協定分析:
   • TCP          : 510,823 (100.0%)

🔍 行為分析:
   🔴 [HIGH] PORT_SCANNING
      檢測到通訊埠掃描：89 個不同通訊埠
   🔴 [HIGH] NETWORK_SCANNING
      檢測到網路掃描：107 個目的地

====================================================================================================
🚨 最終判斷: 真實異常 (置信度: HIGH)
====================================================================================================
💡 建議: 建議立即調查
```

### 判斷類型

| 判斷 | 圖標 | 說明 | 建議 |
|------|------|------|------|
| **TRUE_ANOMALY** | 🚨 | 確認為異常行為 | 立即調查 |
| **SUSPICIOUS** | ⚠️ | 可疑但不確定 | 持續觀察 |
| **FALSE_POSITIVE** | ✅ | 正常流量誤報 | 調整閾值 |
| **UNCLEAR** | ❓ | 無法判斷 | 需要更多數據 |

---

## 🎯 工具 2: tune_thresholds.py

### 功能

批量分析多個異常 IP，統計誤報率，自動生成閾值調整建議。

### 使用方法

#### 方法 1: 手動指定 IP 列表

```bash
python3 tune_thresholds.py --ips '192.168.10.135,192.168.20.56,192.168.15.42' --minutes 30
```

#### 方法 2: 從文件讀取

創建 `anomaly_ips.txt`：
```
192.168.10.135
192.168.20.56
192.168.15.42
192.168.30.88
192.168.40.99
```

執行：
```bash
python3 tune_thresholds.py --file anomaly_ips.txt --minutes 30
```

#### 方法 3: 從 JSON 讀取（推薦）

先保存檢測結果：
```bash
python3 realtime_detection.py --minutes 30 > detection_result.txt
```

手動創建 JSON 格式：
```json
[
  {"ip": "192.168.10.135", "score": 0.6234},
  {"ip": "192.168.20.56", "score": 0.5891},
  {"ip": "192.168.15.42", "score": 0.5123}
]
```

執行：
```bash
python3 tune_thresholds.py --json anomalies.json --minutes 30
```

### 輸出報告

```
====================================================================================================
📊 分析匯總報告
====================================================================================================

📈 檢測結果統計:
   • 總共分析: 5 個 IP
   • 🚨 真實異常: 2 (40.0%)
   • ⚠️  可疑行為: 1 (20.0%)
   • ✅ 誤報: 2 (40.0%)
   • ❓ 無法確定: 0 (0.0%)

🔍 檢測到的行為類型:
   • PORT_SCANNING: 2 次
   • NETWORK_SCANNING: 2 次
   • NORMAL_SERVICE: 2 次

🚨 真實異常詳情:

   IP: 192.168.10.135
   異常分數: 0.623
   • [HIGH] 檢測到通訊埠掃描：89 個不同通訊埠
   • [HIGH] 檢測到網路掃描：107 個目的地

   IP: 192.168.20.56
   異常分數: 0.589
   • [HIGH] 檢測到網路掃描：156 個目的地
   • [MEDIUM] 疑似 DNS 濫用：12,456 個 DNS 查詢

====================================================================================================
🔧 閾值調優建議
====================================================================================================

📌 參數: thresholds.high_connection
   當前值: 1000
   建議值: 2500
   原因: 2 個誤報的連線數超過當前閾值
   影響: 2 個 IP

📌 參數: thresholds.scanning_dsts
   當前值: 30
   建議值: 50
   原因: 2 個誤報的目的地數超過當前閾值
   影響: 2 個 IP

💡 如何應用調整:
   1. 編輯 nad/config.yaml
   2. 修改相應參數
   3. 重新訓練模型: python3 train_isolation_forest.py --days 7
   4. 重新檢測: python3 realtime_detection.py --minutes 30

====================================================================================================
✅ 誤報分析
====================================================================================================

IP: 192.168.1.100 (異常分數: 0.512)
   → 正常服務流量: 80(HTTP), 443(HTTPS), 53(DNS)

IP: 192.168.1.200 (異常分數: 0.489)
   → 正常服務流量: 443(HTTPS), 22(SSH)
```

---

## 🔧 應用閾值調整

### Step 1: 編輯配置文件

```bash
nano nad/config.yaml
```

### Step 2: 修改建議的參數

```yaml
# 根據調優建議修改
thresholds:
  high_connection: 2500      # 從 1000 調整為 2500
  scanning_dsts: 50          # 從 30 調整為 50
  scanning_avg_bytes: 10000  # 保持不變
  small_packet: 1000
  large_flow: 104857600

# 如果誤報率過高，也調整 contamination
isolation_forest:
  contamination: 0.03        # 從 0.05 降低到 0.03
  n_estimators: 150
```

### Step 3: 重新訓練模型

```bash
python3 train_isolation_forest.py --days 7 --evaluate
```

### Step 4: 驗證效果

```bash
# 重新檢測
python3 realtime_detection.py --minutes 30

# 再次驗證異常
python3 verify_anomaly.py --ip <某個異常IP> --minutes 30
```

---

## 📊 檢測到的異常類型

### 1. PORT_SCANNING (通訊埠掃描)

**特徵：**
- 不同通訊埠數 > 20
- 連線數 > 100
- 可能有連續通訊埠（如 80, 81, 82...）

**判斷：**
- 🚨 **真實異常** - 如果是內網主機掃描外網/其他內網
- ✅ **可能正常** - 如果是負載均衡器、代理服務器

### 2. NETWORK_SCANNING (網路掃描)

**特徵：**
- 唯一目的地 > 50
- 目的地多樣性高（> 0.1）
- 平均流量較小

**判斷：**
- 🚨 **真實異常** - 如果不是掃描器、安全設備
- ✅ **可能正常** - 如果是 Nmap、Nessus 等掃描工具主機

### 3. DNS_ABUSE (DNS 濫用)

**特徵：**
- 目的通訊埠 53
- 連線數 > 1000
- 平均流量 < 500 bytes

**判斷：**
- 🚨 **真實異常** - 可能是 DNS 隧道、DDoS
- ✅ **可能正常** - 如果是 DNS 伺服器、快取伺服器

### 4. DATA_EXFILTRATION (數據外洩)

**特徵：**
- 總流量 > 1GB
- 唯一目的地 < 5
- 集中到少數外網 IP

**判斷：**
- 🚨 **真實異常** - 可能是數據竊取
- ✅ **可能正常** - 如果是備份服務器、CDN 同步

### 5. NORMAL_SERVICE (正常服務)

**特徵：**
- 主要通訊埠為 80, 443, 53, 22 等
- 流量模式穩定

**判斷：**
- ✅ **誤報** - 建議調整閾值

---

## 🎯 調優策略

### 策略 1: 降低誤報率

**問題：** 太多正常服務被標記為異常

**解決：**
1. 提高特徵閾值（如 `high_connection`, `scanning_dsts`）
2. 降低 `contamination`（從 0.05 → 0.02）
3. 添加白名單（未來功能）

### 策略 2: 提高檢出率

**問題：** 一些明顯異常沒被檢測到

**解決：**
1. 降低特徵閾值
2. 提高 `contamination`（從 0.05 → 0.10）
3. 增加特徵數量（時間序列特徵）

### 策略 3: 平衡精確度

**建議：**
1. 收集 1 週的數據
2. 每天驗證異常，記錄真假
3. 計算精確率（Precision）和召回率（Recall）
4. 根據業務需求調整

```
精確率 (Precision) = 真實異常 / 所有檢測出的異常
召回率 (Recall) = 檢測出的真實異常 / 所有真實異常

目標：
- 安全優先：Recall > 90%（寧可誤報，不要漏報）
- 運營優先：Precision > 80%（減少誤報，節省人力）
```

---

## 🚀 完整工作流程

### 日常檢測流程

```bash
# 1. 每 5 分鐘檢測一次（持續監控）
python3 realtime_detection.py --continuous --interval 5 --minutes 10

# 2. 發現異常後，立即深入分析
python3 verify_anomaly.py --ip <異常IP> --minutes 30

# 3. 根據分析結果採取行動
#    - 真實異常 → 調查處理
#    - 誤報 → 記錄下來，供調優用
```

### 每週調優流程

```bash
# 1. 收集一週的異常 IP（手動或自動）
#    將異常 IP 記錄到文件

# 2. 批量分析
python3 tune_thresholds.py --file weekly_anomalies.txt --minutes 30

# 3. 查看調優建議，決定是否調整

# 4. 如果調整，重新訓練
python3 train_isolation_forest.py --days 7

# 5. 驗證新模型效果
python3 realtime_detection.py --minutes 30
```

---

## 📝 常見問題

### Q1: 所有檢測都是誤報怎麼辦？

**A:** 這表示模型對你的環境「過於敏感」，建議：
1. 降低 `contamination` 到 0.01-0.02
2. 提高所有特徵閾值 50%
3. 使用更長時間的訓練數據（14 天而非 7 天）

### Q2: 明顯的異常沒被檢測到？

**A:** 模型對你的環境「不夠敏感」，建議：
1. 提高 `contamination` 到 0.08-0.10
2. 降低特徵閾值
3. 檢查該異常在聚合數據中是否存在

### Q3: 如何處理特定正常主機一直被標記？

**A:** 未來可以實現白名單功能，目前：
1. 分析該主機的特徵模式
2. 調整閾值讓該模式變為「正常」
3. 或在檢測結果中手動過濾該 IP

### Q4: 多久應該重新訓練模型？

**A:** 建議：
- **每週重訓練** - 適應網路流量變化
- **重大網路變更後** - 新增服務、設備
- **誤報率突然增加時** - 環境可能已改變

---

## 📚 相關文檔

- **使用指南：** `ISOLATION_FOREST_GUIDE.md`
- **優化總結：** `ML_OPTIMIZATION_SUMMARY.md`
- **配置參考：** `nad/config.yaml`

---

**版本：** 1.0
**更新日期：** 2025-11-12
