# 更新日誌

## 2025-01-17 - MySQL 整合與 UI 改進

### 新增功能

#### 1. MySQL 設備名稱查詢整合
- 整合 MySQL 查詢功能，自動從資料庫查詢 IP 對應的設備名稱
- 查詢來源：
  - `Device` 表：網路設備（交換機、AP、伺服器等）
  - `ip_alias` 表：IP 別名
- 快取機制：避免重複查詢相同 IP，提升效能

#### 2. TOP 5 連線對象顯示
- 簡化版報告：顯示 TOP 5 連線來源/目的地
- 詳細版報告：顯示 TOP 5 + 第 6-20 名
- 動態標題調整：當連線對象少於 5 個時，顯示實際數量

#### 3. 連線狀態顯示
- 啟動時顯示 Elasticsearch 連線狀態
- 啟動時顯示 MySQL 連線狀態
- 連線成功：`✓ 已連接到 MySQL: localhost:3306 (設備名稱查詢已啟用)`
- 連線失敗：`○ MySQL 未連接 (設備名稱查詢功能停用)`

#### 4. 告警訊息優化
- 關閉 Elasticsearch 安全警告訊息
- 使用 `warnings.filterwarnings` 過濾不必要的告警

### 顯示格式改進

**有設備名稱時：**
```
1. 192.168.10.135 (AD server)          →   856 次 (45.2%)
2. 192.168.10.90 (Flie server)         →   312 次 (16.5%)
```

**無設備名稱時：**
```
3. 192.168.20.127                      →   198 次 (10.4%)
```

### 容錯機制

1. **PyMySQL 未安裝**：程式仍可正常運行，不顯示設備名稱
2. **MySQL 連線失敗**：靜默處理，不影響主要功能
3. **查詢失敗**：快取 None 值，避免重複嘗試

### 系統需求

- Python 3.x
- python3-pymysql (透過 `apt install python3-pymysql` 安裝)
- elasticsearch (系統已有)
- numpy (系統已有)
- pyyaml (系統已有)

### 使用範例

```bash
# 分析指定 IP（120 分鐘範圍）
python3 verify_anomaly.py --ip 192.168.0.4 --minutes 120

# 輸出範例：
# ✓ 已連接到 Elasticsearch: http://localhost:9200
# ✓ 已連接到 MySQL: localhost:3306 (設備名稱查詢已啟用)
#
# ====================================================================================================
# 🔍 深入分析: 192.168.0.4
# ====================================================================================================
```

### 技術細節

#### 修改的檔案
- `verify_anomaly.py`
  - 新增 `warnings` 模組導入
  - 新增 `mysql_connected` 狀態追蹤
  - 新增 `_get_ip_name()` 方法：查詢設備名稱
  - 新增 `_format_ip_with_name()` 方法：格式化 IP 顯示
  - 修改 `_print_single_direction_report()`：顯示 TOP 5 連線對象
  - 修改 `_print_report()`：顯示 TOP 5 + 第 6-20 名
  - 修改 `main()`：顯示 MySQL 連線狀態

#### 效能優化
- 使用快取機制減少資料庫查詢次數
- 連線超時設定為 3 秒，避免長時間等待

### 測試結果

```
✓ 已連接到 Elasticsearch: http://localhost:9200
✓ 已連接到 MySQL: localhost:3306 (設備名稱查詢已啟用)

IP 名稱查詢測試:
✓ 192.168.10.135 -> 192.168.10.135 (AD server)
✓ 192.168.10.90  -> 192.168.10.90 (Flie server)
○ 192.168.20.127 -> 192.168.20.127 (未在資料庫註冊)
✓ 192.168.0.112  -> 192.168.0.112 (AP-0.112)
```

### 已知限制

1. IP 地址 `192.168.20.127`, `192.168.20.52`, `192.168.10.21`, `192.168.20.54` 在資料庫中沒有註冊
2. 這些 IP 可能是動態分配的終端設備或尚未被管理員註冊到系統中

### 後續改進建議

1. 考慮加入 IP 地理位置查詢（GeoIP）
2. 支援批量 IP 查詢優化
3. 加入設備類型分類顯示
4. 支援自定義查詢表和欄位
